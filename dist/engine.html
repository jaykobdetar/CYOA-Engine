<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Own Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
:root{--color-bg-primary: #1a1a1a;--color-bg-secondary: #151515;--color-bg-tertiary: #0d0d0d;--color-bg-header: #0d0d0d;--color-bg-input: #2a2a2a;--color-bg-button: linear-gradient(180deg, #2a2a2a 0%, #222 100%);--color-bg-button-hover: linear-gradient(180deg, #333 0%, #2a2a2a 100%);--color-bg-button-primary: linear-gradient(180deg, #2d4a2d 0%, #1e3a1e 100%);--color-bg-button-primary-hover: linear-gradient(180deg, #3d5a3d 0%, #2d4a2d 100%);--color-bg-button-danger: linear-gradient(180deg, #4a2d2d 0%, #3a1e1e 100%);--color-bg-button-danger-hover: linear-gradient(180deg, #5a3d3d 0%, #4a2d2d 100%);--color-text-primary: #d0d0d0;--color-text-secondary: #888;--color-text-muted: #666;--color-text-dim: #555;--color-text-accent: #8a8;--color-text-choice: #8ac;--color-text-ending: #ca8;--color-border-primary: #333;--color-border-secondary: #444;--color-border-focus: #555;--color-border-accent: #3a4a3a;--color-scrollbar-track: #1a1a1a;--color-scrollbar-thumb: #333;--color-scrollbar-thumb-hover: #444;--font-ui: "Segoe UI", system-ui, -apple-system, sans-serif;--font-story: Georgia, "Times New Roman", serif;--font-mono: "Consolas", "Monaco", monospace;--font-size-base: 1rem;--font-size-sm: .85rem;--font-size-xs: .8rem;--font-size-xxs: .75rem;--font-size-story: 1.15rem;--line-height-base: 1.5;--line-height-story: 1.85;--spacing-xs: .25rem;--spacing-sm: .5rem;--spacing-md: .75rem;--spacing-lg: 1rem;--spacing-xl: 1.5rem;--spacing-xxl: 2rem;--radius-sm: 3px;--radius-md: 4px;--radius-lg: 6px;--radius-xl: 8px;--transition-fast: .15s ease;--transition-normal: .2s ease}:root.light-theme{--color-bg-primary: #f5f5f5;--color-bg-secondary: #ffffff;--color-bg-tertiary: #e8e8e8;--color-bg-header: #ffffff;--color-bg-input: #ffffff;--color-bg-button: linear-gradient(180deg, #f0f0f0 0%, #e0e0e0 100%);--color-bg-button-hover: linear-gradient(180deg, #e8e8e8 0%, #d8d8d8 100%);--color-bg-button-primary: linear-gradient(180deg, #4a8a4a 0%, #3a7a3a 100%);--color-bg-button-primary-hover: linear-gradient(180deg, #5a9a5a 0%, #4a8a4a 100%);--color-bg-button-danger: linear-gradient(180deg, #c44 0%, #a33 100%);--color-bg-button-danger-hover: linear-gradient(180deg, #d55 0%, #b44 100%);--color-text-primary: #333;--color-text-secondary: #666;--color-text-muted: #888;--color-text-dim: #aaa;--color-text-accent: #2a6a2a;--color-text-choice: #2a4a6a;--color-text-ending: #8a4a2a;--color-border-primary: #ddd;--color-border-secondary: #ccc;--color-border-focus: #999;--color-border-accent: #4a8a4a;--color-scrollbar-track: #f0f0f0;--color-scrollbar-thumb: #ccc;--color-scrollbar-thumb-hover: #bbb}*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}body{font-family:var(--font-ui);background:var(--color-bg-primary);color:var(--color-text-primary);font-size:var(--font-size-base);line-height:var(--line-height-base)}button{background:var(--color-bg-button);color:#ccc;border:1px solid var(--color-border-primary);padding:.4rem 1rem;font-family:inherit;font-size:var(--font-size-sm);cursor:pointer;border-radius:var(--radius-md);transition:all var(--transition-fast)}button:hover{background:var(--color-bg-button-hover);border-color:var(--color-border-secondary);color:#fff}button:active{transform:translateY(1px)}button.primary{background:var(--color-bg-button-primary);border-color:#3d5a3d}button.primary:hover{background:var(--color-bg-button-primary-hover);border-color:#4d6a4d}button.danger{background:var(--color-bg-button-danger);border-color:#5a3d3d}button.danger:hover{background:var(--color-bg-button-danger-hover)}button:disabled{opacity:.5;cursor:not-allowed}input,textarea,select{background:var(--color-bg-input);border:1px solid var(--color-border-secondary);color:var(--color-text-primary);padding:.5rem .75rem;font-family:inherit;font-size:var(--font-size-sm);border-radius:var(--radius-md);transition:border-color var(--transition-normal),box-shadow var(--transition-normal)}input:focus,textarea:focus,select:focus{outline:none;border-color:var(--color-border-focus);box-shadow:0 0 0 3px #ffffff0d}input::placeholder,textarea::placeholder{color:var(--color-text-dim)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--color-scrollbar-track)}::-webkit-scrollbar-thumb{background:var(--color-scrollbar-thumb);border-radius:var(--radius-md)}::-webkit-scrollbar-thumb:hover{background:var(--color-scrollbar-thumb-hover)}.modal-overlay{display:none;position:fixed;inset:0;background:#000000b3;z-index:100;align-items:center;justify-content:center}.modal-overlay.visible{display:flex}.modal{background:var(--color-bg-primary);border:1px solid var(--color-border-primary);border-radius:var(--radius-xl);padding:var(--spacing-xl);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}.modal h3{font-size:1rem;font-weight:400;margin-bottom:var(--spacing-lg);color:var(--color-text-secondary)}.modal-buttons{display:flex;gap:var(--spacing-md);justify-content:flex-end;margin-top:var(--spacing-xl)}.hidden{display:none!important}.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.text-mono{font-family:var(--font-mono)}.text-muted{color:var(--color-text-muted)}.text-accent{color:var(--color-text-accent)}.kbd{display:inline-block;padding:.1rem .4rem;font-family:var(--font-mono);font-size:.75rem;background:var(--color-bg-tertiary);border:1px solid var(--color-border-primary);border-radius:var(--radius-sm);box-shadow:0 1px 0 var(--color-border-primary)}.toast-container{position:fixed;bottom:var(--spacing-xl);right:var(--spacing-xl);z-index:200;display:flex;flex-direction:column;gap:var(--spacing-sm)}.toast{background:var(--color-bg-secondary);border:1px solid var(--color-border-primary);border-radius:var(--radius-md);padding:var(--spacing-md) var(--spacing-lg);font-size:var(--font-size-sm);box-shadow:0 4px 12px #0000004d;animation:slideIn .3s ease}.toast.success{border-left:3px solid #4a8a4a}.toast.error{border-left:3px solid #8a4a4a}.toast.warning{border-left:3px solid #8a6a3a}@keyframes slideIn{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}.spinner{width:20px;height:20px;border:2px solid var(--color-border-primary);border-top-color:var(--color-text-accent);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.font-size-small{--font-size-story: .95rem}.font-size-medium{--font-size-story: 1.15rem}.font-size-large{--font-size-story: 1.35rem}.font-size-xlarge{--font-size-story: 1.55rem}body{background:linear-gradient(145deg,#0d0d0d,#1a1a1a,#0d0d0d);min-height:100vh;display:flex;flex-direction:column}header{background:#0006;border-bottom:1px solid #2a2a2a;padding:var(--spacing-lg) var(--spacing-xxl);display:flex;justify-content:center;gap:var(--spacing-xxl);flex-wrap:wrap;align-items:center}.control-group{display:flex;align-items:center;gap:var(--spacing-sm)}.control-group label{font-size:var(--font-size-xxs);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:.05em}#story-folder{width:140px}#page-jump{width:90px;font-family:var(--font-mono)}.settings-group{display:flex;align-items:center;gap:var(--spacing-md)}.font-size-control{display:flex;align-items:center;gap:var(--spacing-xs)}.font-size-control button{width:28px;height:28px;padding:0;display:flex;align-items:center;justify-content:center;font-size:1rem}.theme-toggle{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;font-size:1.1rem;border-radius:50%}.volume-control{display:flex;align-items:center;gap:var(--spacing-sm)}.volume-control input[type=range]{width:80px;height:4px;-webkit-appearance:none;background:var(--color-border-primary);border-radius:2px;cursor:pointer}.volume-control input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--color-text-accent);border-radius:50%;cursor:pointer}main{flex:1;display:flex;flex-direction:column;align-items:center;padding:3rem var(--spacing-xxl);overflow-y:auto}#content{width:100%;max-width:800px}#menu{text-align:center;padding-top:15vh}#menu h1{font-size:2rem;font-weight:300;color:var(--color-text-secondary);margin-bottom:var(--spacing-lg);letter-spacing:.1em}#menu p{color:var(--color-text-dim);font-size:.95rem}.story-meta{margin-bottom:var(--spacing-xxl);text-align:center}.story-meta h1{font-size:2.5rem;font-weight:300;margin-bottom:var(--spacing-md);color:var(--color-text-primary)}.story-meta .author{font-size:1rem;color:var(--color-text-muted);margin-bottom:var(--spacing-md)}.story-meta .description{font-size:.95rem;color:var(--color-text-dim);max-width:600px;margin:0 auto var(--spacing-xl);line-height:1.6}#game{display:none}#story{font-family:var(--font-story);font-size:var(--font-size-story);line-height:var(--line-height-story);color:#c8c8c8;margin-bottom:2.5rem}#story p{margin-bottom:1.25rem;text-indent:0}#story p:last-child{margin-bottom:0}#story em,#story i{font-style:italic}#story strong,#story b{font-weight:700;color:#e0e0e0}#story blockquote{border-left:3px solid var(--color-border-primary);padding-left:var(--spacing-lg);margin:var(--spacing-lg) 0;color:var(--color-text-muted);font-style:italic}.story-image{display:block;max-width:100%;margin:1.5rem auto;border-radius:var(--radius-md);box-shadow:0 4px 20px #00000080}.story-image.size-small{max-height:200px;width:auto}.story-image.size-medium{max-height:400px;width:auto}.story-video{display:block;max-width:100%;margin:1.5rem auto;border-radius:var(--radius-md);box-shadow:0 4px 20px #00000080;background:#000}.audio-player{position:fixed;bottom:80px;right:var(--spacing-lg);background:var(--color-bg-secondary);border:1px solid var(--color-border-primary);border-radius:var(--radius-lg);padding:var(--spacing-md);display:none;align-items:center;gap:var(--spacing-sm)}.audio-player.visible{display:flex}.audio-player .audio-title{font-size:var(--font-size-xs);color:var(--color-text-muted);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.audio-player button{width:28px;height:28px;padding:0;font-size:.9rem}#choices{display:flex;flex-direction:column;gap:var(--spacing-md)}#choices button{background:linear-gradient(180deg,#1e1e1e,#181818);border:1px solid #2a2a2a;padding:var(--spacing-lg) 1.25rem;font-family:var(--font-story);font-size:1rem;text-align:left;color:var(--color-text-secondary);border-radius:var(--radius-lg);position:relative;overflow:hidden}#choices button:before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:#444;transition:background var(--transition-normal),width var(--transition-normal)}#choices button:hover{background:linear-gradient(180deg,#252525,#1e1e1e);border-color:#3a3a3a;color:#ddd}#choices button:hover:before{background:#666;width:4px}#choices button:focus{outline:2px solid var(--color-text-accent);outline-offset:2px}#choices button .choice-key{display:inline-block;width:24px;height:24px;background:var(--color-bg-tertiary);border:1px solid var(--color-border-primary);border-radius:var(--radius-sm);text-align:center;line-height:22px;font-family:var(--font-mono);font-size:var(--font-size-xs);margin-right:var(--spacing-sm);color:var(--color-text-muted)}#choices button.continue-btn{text-align:center;color:var(--color-text-secondary);font-style:italic}#choices button.continue-btn:before{display:none}#choices button.continue-btn .choice-key{margin-right:var(--spacing-sm)}#ending{display:none;margin-top:var(--spacing-xxl);padding:var(--spacing-xl);background:#ffffff08;border:1px solid #2a2a2a;border-radius:var(--radius-lg);text-align:center}#ending strong{display:block;font-size:1.1rem;color:var(--color-text-secondary);margin-bottom:var(--spacing-lg);font-weight:400;letter-spacing:.15em;text-transform:uppercase}.variables-panel{position:fixed;top:80px;right:var(--spacing-lg);background:var(--color-bg-secondary);border:1px solid var(--color-border-primary);border-radius:var(--radius-lg);padding:var(--spacing-md);min-width:150px;display:none;font-size:var(--font-size-xs)}.variables-panel.visible{display:block}.variables-panel h4{font-size:var(--font-size-xxs);text-transform:uppercase;letter-spacing:.05em;color:var(--color-text-muted);margin-bottom:var(--spacing-sm);padding-bottom:var(--spacing-xs);border-bottom:1px solid var(--color-border-primary)}.variable-item{display:flex;justify-content:space-between;padding:var(--spacing-xs) 0}.variable-item .var-name{color:var(--color-text-muted)}.variable-item .var-value{font-family:var(--font-mono);color:var(--color-text-accent)}footer{background:#0006;border-top:1px solid #2a2a2a;padding:var(--spacing-md) var(--spacing-xxl);display:none;justify-content:center;gap:3rem;font-size:var(--font-size-xs)}footer.visible{display:flex}.status-item{display:flex;gap:var(--spacing-sm)}.status-label{color:var(--color-text-dim);text-transform:uppercase;letter-spacing:.05em}.status-value{font-family:var(--font-mono);color:var(--color-text-secondary)}.error{color:#a66;font-style:italic;text-align:center;padding:var(--spacing-xxl)}.keyboard-hint{position:fixed;bottom:var(--spacing-lg);left:50%;transform:translate(-50%);background:var(--color-bg-secondary);border:1px solid var(--color-border-primary);border-radius:var(--radius-md);padding:var(--spacing-sm) var(--spacing-lg);font-size:var(--font-size-xs);color:var(--color-text-muted);opacity:0;transition:opacity var(--transition-normal);pointer-events:none}.keyboard-hint.visible{opacity:1}.import-options{display:flex;gap:var(--spacing-lg);justify-content:center;margin-top:var(--spacing-xxl)}.import-option{display:flex;flex-direction:column;align-items:center;gap:var(--spacing-md);padding:var(--spacing-xl);background:var(--color-bg-secondary);border:1px solid var(--color-border-primary);border-radius:var(--radius-lg);cursor:pointer;transition:border-color var(--transition-fast),background var(--transition-fast);min-width:150px}.import-option:hover{border-color:var(--color-text-accent);background:#8aaa8a0d}.import-option .icon{font-size:2rem}.import-option .label{font-size:var(--font-size-sm);color:var(--color-text-secondary)}.import-option input[type=file]{display:none}@media (max-width: 600px){header{padding:var(--spacing-lg);gap:var(--spacing-lg)}main{padding:var(--spacing-xxl) 1.25rem}#story{font-size:1.05rem}footer{gap:1.5rem;flex-wrap:wrap}.settings-group{display:none}.audio-player{bottom:70px;left:var(--spacing-lg);right:var(--spacing-lg);justify-content:center}.variables-panel{top:auto;bottom:80px;left:var(--spacing-lg);right:var(--spacing-lg)}}@media print{header,footer,#choices,.audio-player,.variables-panel{display:none!important}body{background:#fff;color:#000}#story{color:#000}main{padding:0}}

    </style>
</head>
<body>
    <div id="app"></div>
    <script type="module">
function J(e){let t=e.match(/^(\d+)([a-e]*)$/i);return t?{num:parseInt(t[1],10),path:t[2].toLowerCase()}:null}function _(){return"showDirectoryPicker"in window}function T(e){let t=[],r=/\{set:(\w+)=([^}]+)\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({type:"set",name:n[1],value:w(n[2]),fullMatch:n[0]});let o=/\{add:(\w+)(?:=([^}]+))?\}/gi;for(;(n=o.exec(e))!==null;)t.push({type:"add",name:n[1],value:n[2]?w(n[2]):1,fullMatch:n[0]});let i=/\{sub:(\w+)(?:=([^}]+))?\}/gi;for(;(n=i.exec(e))!==null;)t.push({type:"sub",name:n[1],value:n[2]?w(n[2]):1,fullMatch:n[0]});let l=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}/gi;for(;(n=l.exec(e))!==null;)t.push({type:"if",name:n[1],operator:n[2]||"==",value:n[3]?w(n[3]):!0,fullMatch:n[0]});let u=/\{\/if\}/gi;for(;(n=u.exec(e))!==null;)t.push({type:"endif",name:"",fullMatch:n[0]});return t}function w(e){let t=e.trim();if(t==="true")return!0;if(t==="false")return!1;let r=Number(t);return isNaN(r)?t:r}function L(e,t,r="==",n=!0){let o=e[t];if(o===void 0)return r==="!="||r==="=="&&n===!1;switch(r){case"==":return o===n;case"!=":return o!==n;case">":return typeof o=="number"&&typeof n=="number"&&o>n;case"<":return typeof o=="number"&&typeof n=="number"&&o<n;case">=":return typeof o=="number"&&typeof n=="number"&&o>=n;case"<=":return typeof o=="number"&&typeof n=="number"&&o<=n;default:return!1}}function C(e){let t=[],r=/\{music:([^}:]+)(?::(loop))?\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({type:"music",file:n[1],loop:n[2]==="loop",fullMatch:n[0]});let o=/\{sfx:([^}]+)\}/gi;for(;(n=o.exec(e))!==null;)t.push({type:"sfx",file:n[1],loop:!1,fullMatch:n[0]});let i=/\{(?:ambient:)?([^}:]+):loop\}/gi;for(;(n=i.exec(e))!==null;)t.push({type:"ambient",file:n[1],loop:!0,fullMatch:n[0]});let l=/\{stop:(music|sfx|ambient|all)\}/gi;for(;(n=l.exec(e))!==null;)t.push({type:"stop",file:n[1],loop:!1,fullMatch:n[0]});return t}function N(e){let t=[],r=/\{goto:(\d+[a-e]*)\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({pageId:n[1].toLowerCase(),fullMatch:n[0]});return t}function Ae(e){let t=e;return t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/_(.+?)_/g,"<em>$1</em>"),t=t.replace(/"([^"]+)"/g,'"$1"'),t=t.replace(/--/g,"\u2013"),t=t.replace(/---/g,"\u2014"),t=t.replace(/\.\.\./g,"\u2026"),t}function we(e,t){let r=T(e),n=e,o={...t};for(let i of r)if(i.type==="set"&&i.value!==void 0)o[i.name]=i.value,n=n.replace(i.fullMatch,"");else if(i.type==="add"&&typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l+i.value,n=n.replace(i.fullMatch,"")}else if(i.type==="sub"&&typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l-i.value,n=n.replace(i.fullMatch,"")}return n=Te(n,o),{text:n,variables:o}}function Te(e,t){let r=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}([\s\S]*?)\{\/if\}/gi;return e.replace(r,(n,o,i,l,u)=>{let d=l?Le(l.trim()):!0;return L(t,o,i||"==",d)?u:""})}function Le(e){if(e==="true")return!0;if(e==="false")return!1;let t=Number(e);return isNaN(t)?e:t}function Ce(e){let t=e;return t=t.replace(/\{set:\w+=[^}]+\}/gi,""),t=t.replace(/\{add:\w+(?:=[^}]+)?\}/gi,""),t=t.replace(/\{sub:\w+(?:=[^}]+)?\}/gi,""),t=t.replace(/\{music:[^}]+\}/gi,""),t=t.replace(/\{sfx:[^}]+\}/gi,""),t=t.replace(/\{ambient:[^}]+\}/gi,""),t=t.replace(/\{[^}:]+:loop\}/gi,""),t=t.replace(/\{stop:(music|sfx|ambient|all)\}/gi,""),t=t.replace(/\{goto:\d+[a-e]*\}/gi,""),t}function He(e){return e.split(/\n\n+/).map(r=>r.trim()).filter(r=>r).map(r=>`<p>${r.replace(/\n/g,"<br>")}</p>`).join("")}function ke(e){let t=/\{([^}:]+?)(?::(\w+))?\}/g;return e.replace(t,(r,n,o)=>{if(n.startsWith("set:")||n.startsWith("add:")||n.startsWith("sub:")||n.startsWith("if:")||n.startsWith("music:")||n.startsWith("sfx:")||n.startsWith("ambient:")||n.startsWith("goto:")||n.startsWith("stop:")||n==="/if")return r;let i=o?`size-${o}`:"";return`<span class="asset-placeholder" data-asset="${n}" data-size="${i}"></span>`})}function G(e){let t=[],r=/^([a-e])\)\s*(?:\[(\d+[a-e]*)\]\s*)?(.+)$/gim,n;for(;(n=r.exec(e))!==null;)t.push({letter:n[1].toLowerCase(),text:n[3].trim(),goto:n[2]?.toLowerCase()});return{storyText:e.replace(/^[a-e]\)\s*(?:\[\d+[a-e]*\]\s*)?.+$/gim,"").trim(),choices:t}}function U(e,t={}){let{text:r,variables:n}=we(e,t),o=C(r),i=N(r),l=Ce(r);return l=Ae(l),l=ke(l),{html:He(l),variables:n,audioCommands:o,gotoCommands:i}}function K(e,t){return e===1&&t===""?"1":`${e}${t}`}function q(e){return e.length===0?"\u2014":e.join(" \u2192 ")}function Z(){return{currentPage:1,currentPath:"",choiceLog:[],variables:{},storyFolder:"",isPlaying:!1}}function $(e,t=1,r=""){return{...e,currentPage:t,currentPath:r,choiceLog:r.split("").filter(n=>n),isPlaying:!0}}function X(e,t,r){let n=[...e.choiceLog,t];if(r){let o=J(r);if(o)return{...e,currentPage:o.num,currentPath:o.path,choiceLog:n}}return{...e,currentPage:e.currentPage+1,currentPath:e.currentPath+t,choiceLog:n}}function Y(e){return{...e,currentPage:e.currentPage+1}}function Q(e){return{...e,currentPage:1,currentPath:"",choiceLog:[],variables:{}}}function ee(e){return e.currentPage===1&&e.currentPath===""?"1.txt":`${e.currentPage}${e.currentPath}.txt`}function te(e){return K(e.currentPage,e.currentPath)}function Ve(e){let t=e.match(/^(\d+)([a-e]*)$/i);return t?{page:parseInt(t[1],10),path:t[2].toLowerCase()}:null}function ne(e,t){let r=Ve(t);return r?{...e,currentPage:r.page,currentPath:r.path,choiceLog:r.path.split("").filter(n=>n)}:null}function re(e){return q(e.choiceLog)}function oe(e){return{page:e.currentPage,path:e.currentPath,variables:{...e.variables}}}function ie(e,t){return{...e,currentPage:t.page,currentPath:t.path,choiceLog:t.path.split("").filter(r=>r),variables:t.variables||{}}}function se(){return{blobUrls:{},assetsDir:null,zipAssets:null,folderFiles:null}}function S(e){for(let t of Object.values(e.blobUrls))URL.revokeObjectURL(t);e.blobUrls={},e.assetsDir=null,e.zipAssets=null,e.folderFiles=null}function ae(e,t){S(e),e.assetsDir=t}function le(e,t){S(e),e.zipAssets=t}function ue(e,t){S(e),e.folderFiles=t}async function E(e,t){if(e.blobUrls[t])return e.blobUrls[t];let r=null;if(e.assetsDir)try{r=await(await e.assetsDir.getFileHandle(t)).getFile()}catch{r=await $e(e.assetsDir,t)}if(!r&&e.zipAssets&&(r=e.zipAssets[t]||e.zipAssets[`${t}.png`]||e.zipAssets[`${t}.jpg`]||e.zipAssets[`${t}.jpeg`]||e.zipAssets[`${t}.gif`]||e.zipAssets[`${t}.webp`]||e.zipAssets[`${t}.mp4`]||e.zipAssets[`${t}.webm`]||e.zipAssets[`${t}.mp3`]||e.zipAssets[`${t}.wav`]),!r&&e.folderFiles){let o=e.folderFiles[t]||e.folderFiles[`${t}.png`]||e.folderFiles[`${t}.jpg`]||e.folderFiles[`${t}.jpeg`]||e.folderFiles[`${t}.gif`]||e.folderFiles[`${t}.webp`]||e.folderFiles[`${t}.mp4`]||e.folderFiles[`${t}.webm`]||e.folderFiles[`${t}.mp3`]||e.folderFiles[`${t}.wav`];o&&(r=o)}if(!r)return"";let n=URL.createObjectURL(r);return e.blobUrls[t]=n,n}async function $e(e,t){let r=[".png",".jpg",".jpeg",".gif",".webp",".svg",".mp4",".webm",".mov",".mp3",".wav",".ogg",".flac"];for(let n of r)try{return await(await e.getFileHandle(t+n)).getFile()}catch{}return null}async function ce(e,t){let r=/\{([^}:]+?)(?::(\w+))?\}/g,n=[...e.matchAll(r)],o=e;for(let i of n){let[l,u,d]=i;if(u.startsWith("set:")||u.startsWith("add:")||u.startsWith("sub:")||u.startsWith("if:")||u.startsWith("music:")||u.startsWith("sfx:")||u.startsWith("ambient:")||u.startsWith("goto:")||u.startsWith("stop:")||u==="/if")continue;let p=await E(t,u);if(!p){o=o.replace(l,"");continue}let m=d?`size-${d}`:"";Ie(u)?o=o.replace(l,`<video src="${p}" class="story-video ${m}" controls preload="none"></video>`):Fe(u)?o=o.replace(l,""):o=o.replace(l,`<img src="${p}" alt="${u}" class="story-image ${m}">`)}return o}function Ie(e){return/\.(mp4|webm|mov|avi|mkv)$/i.test(e)}function Fe(e){return/\.(mp3|wav|ogg|flac|aac|m4a)$/i.test(e)}function de(){return{musicElement:null,sfxElements:[],ambientElement:null,currentMusic:null,currentAmbient:null,volume:.7,muted:!1}}function pe(e){e.musicElement=document.createElement("audio"),e.musicElement.volume=e.volume,e.ambientElement=document.createElement("audio"),e.ambientElement.volume=e.volume*.5,e.ambientElement.loop=!0}async function me(e,t,r){let n=C(e);for(let o of n)await Be(o,t,r)}async function Be(e,t,r){if(!t.muted)switch(e.type){case"music":await ze(t,r,e.file,e.loop);break;case"sfx":await Oe(t,r,e.file);break;case"ambient":await Re(t,r,e.file);break;case"stop":(e.file==="music"||e.file==="all")&&I(t),(e.file==="ambient"||e.file==="all")&&F(t),(e.file==="sfx"||e.file==="all")&&fe(t);break}}async function ze(e,t,r,n=!1){if(!e.musicElement)return;if(e.currentMusic!==r)I(e);else if(!e.musicElement.paused)return;let o=await E(t,r);if(o){e.musicElement.src=o,e.musicElement.loop=n,e.musicElement.volume=e.volume,e.currentMusic=r;try{await e.musicElement.play()}catch(i){console.warn("Audio autoplay blocked:",i)}}}function I(e){e.musicElement&&(e.musicElement.pause(),e.musicElement.currentTime=0,e.currentMusic=null)}async function Oe(e,t,r){let n=await E(t,r);if(!n)return;let o=document.createElement("audio");o.src=n,o.volume=e.volume,o.addEventListener("ended",()=>{let i=e.sfxElements.indexOf(o);i>-1&&e.sfxElements.splice(i,1)}),e.sfxElements.push(o);try{await o.play()}catch(i){console.warn("SFX autoplay blocked:",i)}}function fe(e){for(let t of e.sfxElements)t.pause(),t.currentTime=0;e.sfxElements=[]}async function Re(e,t,r){if(!e.ambientElement)return;if(e.currentAmbient!==r)F(e);else if(!e.ambientElement.paused)return;let n=await E(t,r);if(n){e.ambientElement.src=n,e.ambientElement.loop=!0,e.ambientElement.volume=e.volume*.5,e.currentAmbient=r;try{await e.ambientElement.play()}catch(o){console.warn("Ambient autoplay blocked:",o)}}}function F(e){e.ambientElement&&(e.ambientElement.pause(),e.ambientElement.currentTime=0,e.currentAmbient=null)}function B(e,t){e.volume=Math.max(0,Math.min(1,t)),e.musicElement&&(e.musicElement.volume=e.volume),e.ambientElement&&(e.ambientElement.volume=e.volume*.5);for(let r of e.sfxElements)r.volume=e.volume}function ge(e,t){e.muted=t,e.musicElement&&(e.musicElement.muted=t),e.ambientElement&&(e.ambientElement.muted=t);for(let r of e.sfxElements)r.muted=t}function z(e){I(e),F(e),fe(e)}function be(e,t){let r=T(e),n=e,o={...t};for(let i of r)switch(i.type){case"set":i.value!==void 0&&(o[i.name]=i.value),n=n.replace(i.fullMatch,"");break;case"add":if(typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l+i.value}n=n.replace(i.fullMatch,"");break;case"sub":if(typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l-i.value}n=n.replace(i.fullMatch,"");break}return n=De(n,o),{text:n,variables:o}}function De(e,t){let r=e,n=!0;for(;n;){n=!1;let o=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}((?:(?!\{if:)[\s\S])*?)\{\/if\}/gi;r=r.replace(o,(i,l,u,d,p)=>{n=!0;let m=d!==void 0?je(d.trim()):!0;return L(t,l,u||"==",m)?p:""})}return r}function je(e){if(e==="true")return!0;if(e==="false")return!1;let t=Number(e);return isNaN(t)?e:t}function ye(e,t){let r=Object.keys(t);if(r.length===0){e.classList.remove("visible");return}e.classList.add("visible"),e.innerHTML=`
    <h4>Variables</h4>
    ${r.map(n=>`
      <div class="variable-item">
        <span class="var-name">${n}</span>
        <span class="var-value">${We(t[n])}</span>
      </div>
    `).join("")}
  `}function We(e){return typeof e=="boolean"?e?"\u2713":"\u2717":String(e)}var P="cyoa_save_",he="cyoa_engine_settings";function M(){return{theme:"dark",fontSize:"medium",volume:.7,muted:!1,showKeyboardHints:!0}}function ve(e,t){let r=P+e;localStorage.setItem(r,JSON.stringify({...t,savedAt:new Date().toISOString()}))}function xe(e){let t=P+e;try{let r=localStorage.getItem(t);if(!r)return null;let n=JSON.parse(r);return{page:n.page||1,path:n.path||"",variables:n.variables||{}}}catch{return null}}function O(e){let t=P+e;localStorage.removeItem(t)}function H(e){let t=P+e;return localStorage.getItem(t)!==null}function A(e){localStorage.setItem(he,JSON.stringify(e))}function Se(){try{let e=localStorage.getItem(he);return e?{...M(),...JSON.parse(e)}:M()}catch{return M()}}function Je(e){let t=P+e;try{let r=localStorage.getItem(t);if(!r)return{exists:!1};let n=JSON.parse(r);return{exists:!0,page:n.page,path:n.path,savedAt:n.savedAt}}catch{return{exists:!1}}}function k(e,t,r){let n=Je(e);if(!n.exists)return null;let o=document.createElement("div");o.className="modal-overlay visible",o.innerHTML=`
    <div class="modal">
      <h3>Continue Playing?</h3>
      <p>You have a saved game at page ${n.page}${n.path||""}.</p>
      ${n.savedAt?`<p style="color: #888; font-size: 0.9rem;">Saved: ${new Date(n.savedAt).toLocaleString()}</p>`:""}
      <div class="modal-buttons">
        <button id="new-game-btn">New Game</button>
        <button id="resume-btn" class="primary">Continue</button>
      </div>
    </div>
  `;let i=o.querySelector("#resume-btn"),l=o.querySelector("#new-game-btn");return i.onclick=()=>{o.remove(),t()},l.onclick=()=>{o.remove(),r()},o}var s=Z(),v=se(),b=de(),c=M(),h=null,f=null,x={},a;function Ee(){a={loadStoryBtn:document.getElementById("load-story"),folderName:document.getElementById("folder-name"),pageJumpInput:document.getElementById("page-jump"),jumpBtn:document.getElementById("jump-btn"),refreshBtn:document.getElementById("refresh-btn"),menu:document.getElementById("menu"),game:document.getElementById("game"),story:document.getElementById("story"),choices:document.getElementById("choices"),ending:document.getElementById("ending"),status:document.getElementById("status"),currentPageDisplay:document.getElementById("current-page-display"),saveCode:document.getElementById("save-code"),logContent:document.getElementById("log-content"),restartBtn:document.getElementById("restart"),themeToggle:document.getElementById("theme-toggle"),fontSizeControls:document.getElementById("font-size-controls"),volumeSlider:document.getElementById("volume-slider"),variablesPanel:document.getElementById("variables-panel"),audioPlayer:document.getElementById("audio-player")},c=Se(),it(),pe(b),_e(),Ne(),_()||Ke()}function _e(){a.loadStoryBtn.onclick=qe,a.jumpBtn.onclick=Me,a.pageJumpInput.onkeydown=e=>{e.key==="Enter"&&Me()},a.refreshBtn.onclick=()=>{s.isPlaying&&y()},a.restartBtn.onclick=W,a.themeToggle&&(a.themeToggle.onclick=st),a.volumeSlider&&(a.volumeSlider.oninput=()=>{let e=parseInt(a.volumeSlider.value)/100;B(b,e),c.volume=e,A(c)}),Ue()}function Ne(){document.addEventListener("keydown",e=>{if(s.isPlaying&&!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(e.key>="a"&&e.key<="e"){let t=a.choices.querySelector(`button[data-choice="${e.key}"]`);t&&(e.preventDefault(),t.click())}if(e.key===" "||e.key==="Enter"){let t=a.choices.querySelector(".continue-btn");t&&(e.preventDefault(),t.click())}e.key==="r"&&!e.ctrlKey&&!e.metaKey&&confirm("Restart the story?")&&W()}}),c.showKeyboardHints&&Ge()}function Ge(){let e=document.createElement("div");e.className="keyboard-hint",e.innerHTML="Press <kbd>a</kbd>-<kbd>e</kbd> for choices, <kbd>space</kbd> to continue",document.body.appendChild(e),setTimeout(()=>e.classList.add("visible"),100),setTimeout(()=>e.classList.remove("visible"),5e3),setTimeout(()=>e.remove(),6e3)}function Ue(){if(!a.fontSizeControls)return;a.fontSizeControls.innerHTML=`
    <button id="font-decrease" title="Decrease font size">A-</button>
    <button id="font-increase" title="Increase font size">A+</button>
  `;let e=document.getElementById("font-decrease"),t=document.getElementById("font-increase"),r=["small","medium","large","xlarge"];e.onclick=()=>{let n=r.indexOf(c.fontSize);n>0&&(c.fontSize=r[n-1],R(),A(c))},t.onclick=()=>{let n=r.indexOf(c.fontSize);n<r.length-1&&(c.fontSize=r[n+1],R(),A(c))}}function Ke(){a.loadStoryBtn.innerHTML="\u{1F4C1} Open Story";let e=document.createElement("input");e.type="file",e.setAttribute("webkitdirectory",""),e.style.display="none",e.id="folder-input";let t=document.createElement("input");t.type="file",t.accept=".zip",t.style.display="none",t.id="zip-input",document.body.appendChild(e),document.body.appendChild(t),a.loadStoryBtn.onclick=()=>{confirm("Open folder? (Cancel for ZIP file)")?e.click():t.click()},e.onchange=Ze,t.onchange=Xe}async function qe(){try{h=await window.showDirectoryPicker(),s.storyFolder=h.name,a.folderName.textContent=s.storyFolder,S(v),z(b);try{let e=await h.getDirectoryHandle("assets");ae(v,e)}catch{}try{let t=await(await h.getFileHandle("story.json")).getFile();f=JSON.parse(await t.text())}catch{f=null}if(H(s.storyFolder)){let e=k(s.storyFolder,()=>D(),()=>g());e?document.body.appendChild(e):g()}else g()}catch(e){e.name!=="AbortError"&&console.error("Error opening folder:",e)}}async function Ze(e){let t=e.target;if(!t.files||t.files.length===0)return;let r={},n={};for(let i of Array.from(t.files)){let d=(i.webkitRelativePath||i.name).split("/").slice(1).join("/");if(d.startsWith("assets/")){let p=d.replace("assets/","");n[p]=i}else r[d]=i}let o=t.files[0].webkitRelativePath||"";s.storyFolder=o.split("/")[0]||"story",a.folderName.textContent=s.storyFolder,x={};for(let[i,l]of Object.entries(r))x[i]=await l.text();if(ue(v,n),r["story.json"])try{f=JSON.parse(await r["story.json"].text())}catch{f=null}if(H(s.storyFolder)){let i=k(s.storyFolder,()=>D(),()=>g());i?document.body.appendChild(i):g()}else g()}async function Xe(e){let t=e.target;if(!t.files||!t.files[0])return;let r=t.files[0];s.storyFolder=r.name.replace(".zip",""),a.folderName.textContent=s.storyFolder;try{let n=new JSZip;await n.loadAsync(r);let o="",l=Object.keys(n.files).find(d=>!n.files[d].dir);l&&l.includes("/")&&(o=l.split("/")[0]+"/"),x={};let u={};for(let[d,p]of Object.entries(n.files)){if(p.dir)continue;let m=d.replace(o,"");if(m.startsWith("assets/")){let V=m.replace("assets/","");u[V]=await p.async("blob")}else if(m.endsWith(".txt"))x[m]=await p.async("string");else if(m==="story.json")try{f=JSON.parse(await p.async("string"))}catch{f=null}}if(le(v,u),H(s.storyFolder)){let d=k(s.storyFolder,()=>D(),()=>g());d?document.body.appendChild(d):g()}else g()}catch(n){alert(`Failed to open ZIP: ${n}`)}}function g(){s={...s,...$(s,1,"")},j(),y()}function D(){let e=xe(s.storyFolder);e?(s=ie(s,e),s.isPlaying=!0):s=$(s,1,""),j(),y()}function j(){a.menu.style.display="none",a.game.style.display="block",a.status.classList.add("visible"),a.ending.style.display="none",f&&Ye()}function Ye(){f&&f.title&&(document.title=f.title)}async function y(){let e=ee(s),t=null;if(h)try{t=await(await(await h.getFileHandle(e)).getFile()).text()}catch{}if(!t&&x[e]&&(t=x[e]),!t){rt();return}await Qe(t),ot(),ve(s.storyFolder,oe(s))}async function Qe(e){let{text:t,variables:r}=be(e,s.variables);s.variables=r;let{storyText:n,choices:o}=G(t),{html:i}=U(n,s.variables),l=await ce(i,v);a.story.innerHTML=DOMPurify.sanitize(l,{ALLOWED_TAGS:["p","br","img","video","strong","em","b","i","blockquote","mark"],ALLOWED_ATTR:["src","alt","class","controls","preload"]}),await me(e,b,v),a.variablesPanel&&ye(a.variablesPanel,s.variables),et(o)}function et(e){if(a.choices.innerHTML="",e.length>0)for(let t of e){let r=document.createElement("button");r.dataset.choice=t.letter,r.innerHTML=`
        <span class="choice-key">${t.letter.toUpperCase()}</span>
        ${DOMPurify.sanitize(t.text,{ALLOWED_TAGS:[]})}
      `,r.onclick=()=>tt(t.letter,t.goto),a.choices.appendChild(r)}else{let t=document.createElement("button");t.className="continue-btn",t.innerHTML='<span class="choice-key">Space</span> Continue',t.onclick=nt,a.choices.appendChild(t)}}function tt(e,t){s=X(s,e,t),y()}function nt(){s=Y(s),y()}function rt(){a.ending.style.display="block",a.choices.innerHTML="",O(s.storyFolder)}function W(){O(s.storyFolder),z(b),s=Q(s),a.ending.style.display="none",y()}function Me(){let e=a.pageJumpInput.value.trim();if(!e)return;if(!s.storyFolder){alert("Please open a story first.");return}let t=ne(s,e);if(!t){a.story.innerHTML='<p class="error">Invalid page code. Use format like "1", "3ab", "5baa".</p>';return}s={...t,isPlaying:!0},s.isPlaying||j(),y(),a.pageJumpInput.value=""}function ot(){a.currentPageDisplay.textContent=String(s.currentPage),a.saveCode.textContent=te(s),a.logContent.textContent=re(s)}function it(){Pe(),R(),a.volumeSlider&&(a.volumeSlider.value=String(c.volume*100)),B(b,c.volume),ge(b,c.muted)}function Pe(){document.documentElement.classList.toggle("light-theme",c.theme==="light"),a.themeToggle&&(a.themeToggle.textContent=c.theme==="dark"?"\u{1F319}":"\u2600\uFE0F")}function R(){document.body.classList.remove("font-size-small","font-size-medium","font-size-large","font-size-xlarge"),document.body.classList.add(`font-size-${c.fontSize}`)}function st(){c.theme=c.theme==="dark"?"light":"dark",Pe(),A(c)}window.restartGame=W;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ee):Ee();export{Ee as init};

    </script>
</body>
</html>