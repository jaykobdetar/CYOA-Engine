function J(e){let t=e.match(/^(\d+)([a-e]*)$/i);return t?{num:parseInt(t[1],10),path:t[2].toLowerCase()}:null}function _(){return"showDirectoryPicker"in window}function T(e){let t=[],r=/\{set:(\w+)=([^}]+)\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({type:"set",name:n[1],value:w(n[2]),fullMatch:n[0]});let o=/\{add:(\w+)(?:=([^}]+))?\}/gi;for(;(n=o.exec(e))!==null;)t.push({type:"add",name:n[1],value:n[2]?w(n[2]):1,fullMatch:n[0]});let i=/\{sub:(\w+)(?:=([^}]+))?\}/gi;for(;(n=i.exec(e))!==null;)t.push({type:"sub",name:n[1],value:n[2]?w(n[2]):1,fullMatch:n[0]});let l=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}/gi;for(;(n=l.exec(e))!==null;)t.push({type:"if",name:n[1],operator:n[2]||"==",value:n[3]?w(n[3]):!0,fullMatch:n[0]});let u=/\{\/if\}/gi;for(;(n=u.exec(e))!==null;)t.push({type:"endif",name:"",fullMatch:n[0]});return t}function w(e){let t=e.trim();if(t==="true")return!0;if(t==="false")return!1;let r=Number(t);return isNaN(r)?t:r}function L(e,t,r="==",n=!0){let o=e[t];if(o===void 0)return r==="!="||r==="=="&&n===!1;switch(r){case"==":return o===n;case"!=":return o!==n;case">":return typeof o=="number"&&typeof n=="number"&&o>n;case"<":return typeof o=="number"&&typeof n=="number"&&o<n;case">=":return typeof o=="number"&&typeof n=="number"&&o>=n;case"<=":return typeof o=="number"&&typeof n=="number"&&o<=n;default:return!1}}function C(e){let t=[],r=/\{music:([^}:]+)(?::(loop))?\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({type:"music",file:n[1],loop:n[2]==="loop",fullMatch:n[0]});let o=/\{sfx:([^}]+)\}/gi;for(;(n=o.exec(e))!==null;)t.push({type:"sfx",file:n[1],loop:!1,fullMatch:n[0]});let i=/\{(?:ambient:)?([^}:]+):loop\}/gi;for(;(n=i.exec(e))!==null;)t.push({type:"ambient",file:n[1],loop:!0,fullMatch:n[0]});let l=/\{stop:(music|sfx|ambient|all)\}/gi;for(;(n=l.exec(e))!==null;)t.push({type:"stop",file:n[1],loop:!1,fullMatch:n[0]});return t}function N(e){let t=[],r=/\{goto:(\d+[a-e]*)\}/gi,n;for(;(n=r.exec(e))!==null;)t.push({pageId:n[1].toLowerCase(),fullMatch:n[0]});return t}function Ae(e){let t=e;return t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/_(.+?)_/g,"<em>$1</em>"),t=t.replace(/"([^"]+)"/g,'"$1"'),t=t.replace(/--/g,"\u2013"),t=t.replace(/---/g,"\u2014"),t=t.replace(/\.\.\./g,"\u2026"),t}function we(e,t){let r=T(e),n=e,o={...t};for(let i of r)if(i.type==="set"&&i.value!==void 0)o[i.name]=i.value,n=n.replace(i.fullMatch,"");else if(i.type==="add"&&typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l+i.value,n=n.replace(i.fullMatch,"")}else if(i.type==="sub"&&typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l-i.value,n=n.replace(i.fullMatch,"")}return n=Te(n,o),{text:n,variables:o}}function Te(e,t){let r=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}([\s\S]*?)\{\/if\}/gi;return e.replace(r,(n,o,i,l,u)=>{let d=l?Le(l.trim()):!0;return L(t,o,i||"==",d)?u:""})}function Le(e){if(e==="true")return!0;if(e==="false")return!1;let t=Number(e);return isNaN(t)?e:t}function Ce(e){let t=e;return t=t.replace(/\{set:\w+=[^}]+\}/gi,""),t=t.replace(/\{add:\w+(?:=[^}]+)?\}/gi,""),t=t.replace(/\{sub:\w+(?:=[^}]+)?\}/gi,""),t=t.replace(/\{music:[^}]+\}/gi,""),t=t.replace(/\{sfx:[^}]+\}/gi,""),t=t.replace(/\{ambient:[^}]+\}/gi,""),t=t.replace(/\{[^}:]+:loop\}/gi,""),t=t.replace(/\{stop:(music|sfx|ambient|all)\}/gi,""),t=t.replace(/\{goto:\d+[a-e]*\}/gi,""),t}function He(e){return e.split(/\n\n+/).map(r=>r.trim()).filter(r=>r).map(r=>`<p>${r.replace(/\n/g,"<br>")}</p>`).join("")}function ke(e){let t=/\{([^}:]+?)(?::(\w+))?\}/g;return e.replace(t,(r,n,o)=>{if(n.startsWith("set:")||n.startsWith("add:")||n.startsWith("sub:")||n.startsWith("if:")||n.startsWith("music:")||n.startsWith("sfx:")||n.startsWith("ambient:")||n.startsWith("goto:")||n.startsWith("stop:")||n==="/if")return r;let i=o?`size-${o}`:"";return`<span class="asset-placeholder" data-asset="${n}" data-size="${i}"></span>`})}function G(e){let t=[],r=/^([a-e])\)\s*(?:\[(\d+[a-e]*)\]\s*)?(.+)$/gim,n;for(;(n=r.exec(e))!==null;)t.push({letter:n[1].toLowerCase(),text:n[3].trim(),goto:n[2]?.toLowerCase()});return{storyText:e.replace(/^[a-e]\)\s*(?:\[\d+[a-e]*\]\s*)?.+$/gim,"").trim(),choices:t}}function U(e,t={}){let{text:r,variables:n}=we(e,t),o=C(r),i=N(r),l=Ce(r);return l=Ae(l),l=ke(l),{html:He(l),variables:n,audioCommands:o,gotoCommands:i}}function K(e,t){return e===1&&t===""?"1":`${e}${t}`}function q(e){return e.length===0?"\u2014":e.join(" \u2192 ")}function Z(){return{currentPage:1,currentPath:"",choiceLog:[],variables:{},storyFolder:"",isPlaying:!1}}function $(e,t=1,r=""){return{...e,currentPage:t,currentPath:r,choiceLog:r.split("").filter(n=>n),isPlaying:!0}}function X(e,t,r){let n=[...e.choiceLog,t];if(r){let o=J(r);if(o)return{...e,currentPage:o.num,currentPath:o.path,choiceLog:n}}return{...e,currentPage:e.currentPage+1,currentPath:e.currentPath+t,choiceLog:n}}function Y(e){return{...e,currentPage:e.currentPage+1}}function Q(e){return{...e,currentPage:1,currentPath:"",choiceLog:[],variables:{}}}function ee(e){return e.currentPage===1&&e.currentPath===""?"1.txt":`${e.currentPage}${e.currentPath}.txt`}function te(e){return K(e.currentPage,e.currentPath)}function Ve(e){let t=e.match(/^(\d+)([a-e]*)$/i);return t?{page:parseInt(t[1],10),path:t[2].toLowerCase()}:null}function ne(e,t){let r=Ve(t);return r?{...e,currentPage:r.page,currentPath:r.path,choiceLog:r.path.split("").filter(n=>n)}:null}function re(e){return q(e.choiceLog)}function oe(e){return{page:e.currentPage,path:e.currentPath,variables:{...e.variables}}}function ie(e,t){return{...e,currentPage:t.page,currentPath:t.path,choiceLog:t.path.split("").filter(r=>r),variables:t.variables||{}}}function se(){return{blobUrls:{},assetsDir:null,zipAssets:null,folderFiles:null}}function S(e){for(let t of Object.values(e.blobUrls))URL.revokeObjectURL(t);e.blobUrls={},e.assetsDir=null,e.zipAssets=null,e.folderFiles=null}function ae(e,t){S(e),e.assetsDir=t}function le(e,t){S(e),e.zipAssets=t}function ue(e,t){S(e),e.folderFiles=t}async function E(e,t){if(e.blobUrls[t])return e.blobUrls[t];let r=null;if(e.assetsDir)try{r=await(await e.assetsDir.getFileHandle(t)).getFile()}catch{r=await $e(e.assetsDir,t)}if(!r&&e.zipAssets&&(r=e.zipAssets[t]||e.zipAssets[`${t}.png`]||e.zipAssets[`${t}.jpg`]||e.zipAssets[`${t}.jpeg`]||e.zipAssets[`${t}.gif`]||e.zipAssets[`${t}.webp`]||e.zipAssets[`${t}.mp4`]||e.zipAssets[`${t}.webm`]||e.zipAssets[`${t}.mp3`]||e.zipAssets[`${t}.wav`]),!r&&e.folderFiles){let o=e.folderFiles[t]||e.folderFiles[`${t}.png`]||e.folderFiles[`${t}.jpg`]||e.folderFiles[`${t}.jpeg`]||e.folderFiles[`${t}.gif`]||e.folderFiles[`${t}.webp`]||e.folderFiles[`${t}.mp4`]||e.folderFiles[`${t}.webm`]||e.folderFiles[`${t}.mp3`]||e.folderFiles[`${t}.wav`];o&&(r=o)}if(!r)return"";let n=URL.createObjectURL(r);return e.blobUrls[t]=n,n}async function $e(e,t){let r=[".png",".jpg",".jpeg",".gif",".webp",".svg",".mp4",".webm",".mov",".mp3",".wav",".ogg",".flac"];for(let n of r)try{return await(await e.getFileHandle(t+n)).getFile()}catch{}return null}async function ce(e,t){let r=/\{([^}:]+?)(?::(\w+))?\}/g,n=[...e.matchAll(r)],o=e;for(let i of n){let[l,u,d]=i;if(u.startsWith("set:")||u.startsWith("add:")||u.startsWith("sub:")||u.startsWith("if:")||u.startsWith("music:")||u.startsWith("sfx:")||u.startsWith("ambient:")||u.startsWith("goto:")||u.startsWith("stop:")||u==="/if")continue;let p=await E(t,u);if(!p){o=o.replace(l,"");continue}let m=d?`size-${d}`:"";Ie(u)?o=o.replace(l,`<video src="${p}" class="story-video ${m}" controls preload="none"></video>`):Fe(u)?o=o.replace(l,""):o=o.replace(l,`<img src="${p}" alt="${u}" class="story-image ${m}">`)}return o}function Ie(e){return/\.(mp4|webm|mov|avi|mkv)$/i.test(e)}function Fe(e){return/\.(mp3|wav|ogg|flac|aac|m4a)$/i.test(e)}function de(){return{musicElement:null,sfxElements:[],ambientElement:null,currentMusic:null,currentAmbient:null,volume:.7,muted:!1}}function pe(e){e.musicElement=document.createElement("audio"),e.musicElement.volume=e.volume,e.ambientElement=document.createElement("audio"),e.ambientElement.volume=e.volume*.5,e.ambientElement.loop=!0}async function me(e,t,r){let n=C(e);for(let o of n)await Be(o,t,r)}async function Be(e,t,r){if(!t.muted)switch(e.type){case"music":await ze(t,r,e.file,e.loop);break;case"sfx":await Oe(t,r,e.file);break;case"ambient":await Re(t,r,e.file);break;case"stop":(e.file==="music"||e.file==="all")&&I(t),(e.file==="ambient"||e.file==="all")&&F(t),(e.file==="sfx"||e.file==="all")&&fe(t);break}}async function ze(e,t,r,n=!1){if(!e.musicElement)return;if(e.currentMusic!==r)I(e);else if(!e.musicElement.paused)return;let o=await E(t,r);if(o){e.musicElement.src=o,e.musicElement.loop=n,e.musicElement.volume=e.volume,e.currentMusic=r;try{await e.musicElement.play()}catch(i){console.warn("Audio autoplay blocked:",i)}}}function I(e){e.musicElement&&(e.musicElement.pause(),e.musicElement.currentTime=0,e.currentMusic=null)}async function Oe(e,t,r){let n=await E(t,r);if(!n)return;let o=document.createElement("audio");o.src=n,o.volume=e.volume,o.addEventListener("ended",()=>{let i=e.sfxElements.indexOf(o);i>-1&&e.sfxElements.splice(i,1)}),e.sfxElements.push(o);try{await o.play()}catch(i){console.warn("SFX autoplay blocked:",i)}}function fe(e){for(let t of e.sfxElements)t.pause(),t.currentTime=0;e.sfxElements=[]}async function Re(e,t,r){if(!e.ambientElement)return;if(e.currentAmbient!==r)F(e);else if(!e.ambientElement.paused)return;let n=await E(t,r);if(n){e.ambientElement.src=n,e.ambientElement.loop=!0,e.ambientElement.volume=e.volume*.5,e.currentAmbient=r;try{await e.ambientElement.play()}catch(o){console.warn("Ambient autoplay blocked:",o)}}}function F(e){e.ambientElement&&(e.ambientElement.pause(),e.ambientElement.currentTime=0,e.currentAmbient=null)}function B(e,t){e.volume=Math.max(0,Math.min(1,t)),e.musicElement&&(e.musicElement.volume=e.volume),e.ambientElement&&(e.ambientElement.volume=e.volume*.5);for(let r of e.sfxElements)r.volume=e.volume}function ge(e,t){e.muted=t,e.musicElement&&(e.musicElement.muted=t),e.ambientElement&&(e.ambientElement.muted=t);for(let r of e.sfxElements)r.muted=t}function z(e){I(e),F(e),fe(e)}function be(e,t){let r=T(e),n=e,o={...t};for(let i of r)switch(i.type){case"set":i.value!==void 0&&(o[i.name]=i.value),n=n.replace(i.fullMatch,"");break;case"add":if(typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l+i.value}n=n.replace(i.fullMatch,"");break;case"sub":if(typeof i.value=="number"){let l=typeof o[i.name]=="number"?o[i.name]:0;o[i.name]=l-i.value}n=n.replace(i.fullMatch,"");break}return n=De(n,o),{text:n,variables:o}}function De(e,t){let r=e,n=!0;for(;n;){n=!1;let o=/\{if:(\w+)(?:(==|!=|>=|<=|>|<)([^}]+))?\}((?:(?!\{if:)[\s\S])*?)\{\/if\}/gi;r=r.replace(o,(i,l,u,d,p)=>{n=!0;let m=d!==void 0?je(d.trim()):!0;return L(t,l,u||"==",m)?p:""})}return r}function je(e){if(e==="true")return!0;if(e==="false")return!1;let t=Number(e);return isNaN(t)?e:t}function ye(e,t){let r=Object.keys(t);if(r.length===0){e.classList.remove("visible");return}e.classList.add("visible"),e.innerHTML=`
    <h4>Variables</h4>
    ${r.map(n=>`
      <div class="variable-item">
        <span class="var-name">${n}</span>
        <span class="var-value">${We(t[n])}</span>
      </div>
    `).join("")}
  `}function We(e){return typeof e=="boolean"?e?"\u2713":"\u2717":String(e)}var P="cyoa_save_",he="cyoa_engine_settings";function M(){return{theme:"dark",fontSize:"medium",volume:.7,muted:!1,showKeyboardHints:!0}}function ve(e,t){let r=P+e;localStorage.setItem(r,JSON.stringify({...t,savedAt:new Date().toISOString()}))}function xe(e){let t=P+e;try{let r=localStorage.getItem(t);if(!r)return null;let n=JSON.parse(r);return{page:n.page||1,path:n.path||"",variables:n.variables||{}}}catch{return null}}function O(e){let t=P+e;localStorage.removeItem(t)}function H(e){let t=P+e;return localStorage.getItem(t)!==null}function A(e){localStorage.setItem(he,JSON.stringify(e))}function Se(){try{let e=localStorage.getItem(he);return e?{...M(),...JSON.parse(e)}:M()}catch{return M()}}function Je(e){let t=P+e;try{let r=localStorage.getItem(t);if(!r)return{exists:!1};let n=JSON.parse(r);return{exists:!0,page:n.page,path:n.path,savedAt:n.savedAt}}catch{return{exists:!1}}}function k(e,t,r){let n=Je(e);if(!n.exists)return null;let o=document.createElement("div");o.className="modal-overlay visible",o.innerHTML=`
    <div class="modal">
      <h3>Continue Playing?</h3>
      <p>You have a saved game at page ${n.page}${n.path||""}.</p>
      ${n.savedAt?`<p style="color: #888; font-size: 0.9rem;">Saved: ${new Date(n.savedAt).toLocaleString()}</p>`:""}
      <div class="modal-buttons">
        <button id="new-game-btn">New Game</button>
        <button id="resume-btn" class="primary">Continue</button>
      </div>
    </div>
  `;let i=o.querySelector("#resume-btn"),l=o.querySelector("#new-game-btn");return i.onclick=()=>{o.remove(),t()},l.onclick=()=>{o.remove(),r()},o}var s=Z(),v=se(),b=de(),c=M(),h=null,f=null,x={},a;function Ee(){a={loadStoryBtn:document.getElementById("load-story"),folderName:document.getElementById("folder-name"),pageJumpInput:document.getElementById("page-jump"),jumpBtn:document.getElementById("jump-btn"),refreshBtn:document.getElementById("refresh-btn"),menu:document.getElementById("menu"),game:document.getElementById("game"),story:document.getElementById("story"),choices:document.getElementById("choices"),ending:document.getElementById("ending"),status:document.getElementById("status"),currentPageDisplay:document.getElementById("current-page-display"),saveCode:document.getElementById("save-code"),logContent:document.getElementById("log-content"),restartBtn:document.getElementById("restart"),themeToggle:document.getElementById("theme-toggle"),fontSizeControls:document.getElementById("font-size-controls"),volumeSlider:document.getElementById("volume-slider"),variablesPanel:document.getElementById("variables-panel"),audioPlayer:document.getElementById("audio-player")},c=Se(),it(),pe(b),_e(),Ne(),_()||Ke()}function _e(){a.loadStoryBtn.onclick=qe,a.jumpBtn.onclick=Me,a.pageJumpInput.onkeydown=e=>{e.key==="Enter"&&Me()},a.refreshBtn.onclick=()=>{s.isPlaying&&y()},a.restartBtn.onclick=W,a.themeToggle&&(a.themeToggle.onclick=st),a.volumeSlider&&(a.volumeSlider.oninput=()=>{let e=parseInt(a.volumeSlider.value)/100;B(b,e),c.volume=e,A(c)}),Ue()}function Ne(){document.addEventListener("keydown",e=>{if(s.isPlaying&&!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(e.key>="a"&&e.key<="e"){let t=a.choices.querySelector(`button[data-choice="${e.key}"]`);t&&(e.preventDefault(),t.click())}if(e.key===" "||e.key==="Enter"){let t=a.choices.querySelector(".continue-btn");t&&(e.preventDefault(),t.click())}e.key==="r"&&!e.ctrlKey&&!e.metaKey&&confirm("Restart the story?")&&W()}}),c.showKeyboardHints&&Ge()}function Ge(){let e=document.createElement("div");e.className="keyboard-hint",e.innerHTML="Press <kbd>a</kbd>-<kbd>e</kbd> for choices, <kbd>space</kbd> to continue",document.body.appendChild(e),setTimeout(()=>e.classList.add("visible"),100),setTimeout(()=>e.classList.remove("visible"),5e3),setTimeout(()=>e.remove(),6e3)}function Ue(){if(!a.fontSizeControls)return;a.fontSizeControls.innerHTML=`
    <button id="font-decrease" title="Decrease font size">A-</button>
    <button id="font-increase" title="Increase font size">A+</button>
  `;let e=document.getElementById("font-decrease"),t=document.getElementById("font-increase"),r=["small","medium","large","xlarge"];e.onclick=()=>{let n=r.indexOf(c.fontSize);n>0&&(c.fontSize=r[n-1],R(),A(c))},t.onclick=()=>{let n=r.indexOf(c.fontSize);n<r.length-1&&(c.fontSize=r[n+1],R(),A(c))}}function Ke(){a.loadStoryBtn.innerHTML="\u{1F4C1} Open Story";let e=document.createElement("input");e.type="file",e.setAttribute("webkitdirectory",""),e.style.display="none",e.id="folder-input";let t=document.createElement("input");t.type="file",t.accept=".zip",t.style.display="none",t.id="zip-input",document.body.appendChild(e),document.body.appendChild(t),a.loadStoryBtn.onclick=()=>{confirm("Open folder? (Cancel for ZIP file)")?e.click():t.click()},e.onchange=Ze,t.onchange=Xe}async function qe(){try{h=await window.showDirectoryPicker(),s.storyFolder=h.name,a.folderName.textContent=s.storyFolder,S(v),z(b);try{let e=await h.getDirectoryHandle("assets");ae(v,e)}catch{}try{let t=await(await h.getFileHandle("story.json")).getFile();f=JSON.parse(await t.text())}catch{f=null}if(H(s.storyFolder)){let e=k(s.storyFolder,()=>D(),()=>g());e?document.body.appendChild(e):g()}else g()}catch(e){e.name!=="AbortError"&&console.error("Error opening folder:",e)}}async function Ze(e){let t=e.target;if(!t.files||t.files.length===0)return;let r={},n={};for(let i of Array.from(t.files)){let d=(i.webkitRelativePath||i.name).split("/").slice(1).join("/");if(d.startsWith("assets/")){let p=d.replace("assets/","");n[p]=i}else r[d]=i}let o=t.files[0].webkitRelativePath||"";s.storyFolder=o.split("/")[0]||"story",a.folderName.textContent=s.storyFolder,x={};for(let[i,l]of Object.entries(r))x[i]=await l.text();if(ue(v,n),r["story.json"])try{f=JSON.parse(await r["story.json"].text())}catch{f=null}if(H(s.storyFolder)){let i=k(s.storyFolder,()=>D(),()=>g());i?document.body.appendChild(i):g()}else g()}async function Xe(e){let t=e.target;if(!t.files||!t.files[0])return;let r=t.files[0];s.storyFolder=r.name.replace(".zip",""),a.folderName.textContent=s.storyFolder;try{let n=new JSZip;await n.loadAsync(r);let o="",l=Object.keys(n.files).find(d=>!n.files[d].dir);l&&l.includes("/")&&(o=l.split("/")[0]+"/"),x={};let u={};for(let[d,p]of Object.entries(n.files)){if(p.dir)continue;let m=d.replace(o,"");if(m.startsWith("assets/")){let V=m.replace("assets/","");u[V]=await p.async("blob")}else if(m.endsWith(".txt"))x[m]=await p.async("string");else if(m==="story.json")try{f=JSON.parse(await p.async("string"))}catch{f=null}}if(le(v,u),H(s.storyFolder)){let d=k(s.storyFolder,()=>D(),()=>g());d?document.body.appendChild(d):g()}else g()}catch(n){alert(`Failed to open ZIP: ${n}`)}}function g(){s={...s,...$(s,1,"")},j(),y()}function D(){let e=xe(s.storyFolder);e?(s=ie(s,e),s.isPlaying=!0):s=$(s,1,""),j(),y()}function j(){a.menu.style.display="none",a.game.style.display="block",a.status.classList.add("visible"),a.ending.style.display="none",f&&Ye()}function Ye(){f&&f.title&&(document.title=f.title)}async function y(){let e=ee(s),t=null;if(h)try{t=await(await(await h.getFileHandle(e)).getFile()).text()}catch{}if(!t&&x[e]&&(t=x[e]),!t){rt();return}await Qe(t),ot(),ve(s.storyFolder,oe(s))}async function Qe(e){let{text:t,variables:r}=be(e,s.variables);s.variables=r;let{storyText:n,choices:o}=G(t),{html:i}=U(n,s.variables),l=await ce(i,v);a.story.innerHTML=DOMPurify.sanitize(l,{ALLOWED_TAGS:["p","br","img","video","strong","em","b","i","blockquote","mark"],ALLOWED_ATTR:["src","alt","class","controls","preload"]}),await me(e,b,v),a.variablesPanel&&ye(a.variablesPanel,s.variables),et(o)}function et(e){if(a.choices.innerHTML="",e.length>0)for(let t of e){let r=document.createElement("button");r.dataset.choice=t.letter,r.innerHTML=`
        <span class="choice-key">${t.letter.toUpperCase()}</span>
        ${DOMPurify.sanitize(t.text,{ALLOWED_TAGS:[]})}
      `,r.onclick=()=>tt(t.letter,t.goto),a.choices.appendChild(r)}else{let t=document.createElement("button");t.className="continue-btn",t.innerHTML='<span class="choice-key">Space</span> Continue',t.onclick=nt,a.choices.appendChild(t)}}function tt(e,t){s=X(s,e,t),y()}function nt(){s=Y(s),y()}function rt(){a.ending.style.display="block",a.choices.innerHTML="",O(s.storyFolder)}function W(){O(s.storyFolder),z(b),s=Q(s),a.ending.style.display="none",y()}function Me(){let e=a.pageJumpInput.value.trim();if(!e)return;if(!s.storyFolder){alert("Please open a story first.");return}let t=ne(s,e);if(!t){a.story.innerHTML='<p class="error">Invalid page code. Use format like "1", "3ab", "5baa".</p>';return}s={...t,isPlaying:!0},s.isPlaying||j(),y(),a.pageJumpInput.value=""}function ot(){a.currentPageDisplay.textContent=String(s.currentPage),a.saveCode.textContent=te(s),a.logContent.textContent=re(s)}function it(){Pe(),R(),a.volumeSlider&&(a.volumeSlider.value=String(c.volume*100)),B(b,c.volume),ge(b,c.muted)}function Pe(){document.documentElement.classList.toggle("light-theme",c.theme==="light"),a.themeToggle&&(a.themeToggle.textContent=c.theme==="dark"?"\u{1F319}":"\u2600\uFE0F")}function R(){document.body.classList.remove("font-size-small","font-size-medium","font-size-large","font-size-xlarge"),document.body.classList.add(`font-size-${c.fontSize}`)}function st(){c.theme=c.theme==="dark"?"light":"dark",Pe(),A(c)}window.restartGame=W;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ee):Ee();export{Ee as init};
