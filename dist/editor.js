function v(e){return e.replace(/[^a-zA-Z0-9._-]/g,"_").replace(/\.{2,}/g,".").replace(/^\.+|\.+$/g,"")}function h(e){let t=e.match(/^(\d+)([a-e]*)$/i);return t?{num:parseInt(t[1],10),path:t[2].toLowerCase()}:null}function E(e,t=2){let n=h(e);if(!n)return{};let s=n.num+1,r=n.path,o="abcde".slice(0,t),i={};for(let l of o)i[l]=`${s}${r}${l}`;return i}function L(e,t,n=5){let s=[],r=[e];for(;r.length>0;){let o=r.shift(),i=E(o,n);for(let l of Object.values(i))t[l]&&(s.push(l),r.push(l))}return s}function q(e,t){let n=h(e),s=h(t);return!n||!s?e.localeCompare(t):n.num!==s.num?n.num-s.num:n.path.localeCompare(s.path)}function J(e,t){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e(...s),t)}}function m(e){return JSON.parse(JSON.stringify(e))}function T(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}function A(e){return e.replace(/\s/g,"").length}function D(e){return e.split(/\n\n+/).filter(t=>t.trim().length>0).length}function N(e){let t=[];return e.hasChoices&&(e.choiceA&&t.push({letter:"a",text:e.choiceA}),e.choiceB&&t.push({letter:"b",text:e.choiceB})),{content:e.content,hasChoices:e.hasChoices,isEnding:e.isEnding,choices:t}}function H(e){return typeof e=="object"&&e!==null&&"choiceA"in e&&"choiceB"in e}function C(e=!0){return{content:"",hasChoices:e,isEnding:!1,choices:e?[{letter:"a",text:""},{letter:"b",text:""}]:[]}}function Z(e){return[...e].sort(q)}function Be(e){let t=Object.keys(e),n=new Set,s=[];function r(o,i){if(!e[o]||n.has(o))return null;n.add(o);let l=e[o],d=[];if(l.hasChoices&&!l.isEnding){let g=E(o,l.choices.length||2);for(let[f,p]of Object.entries(g)){let I=l.choices.find(k=>k.letter===f)?.goto||p;if(e[I]){let k=r(I,i+1);k&&d.push(k)}}}else if(!l.isEnding){let g=h(o);if(g){let f=`${g.num+1}${g.path}`;if(e[f]){let p=r(f,i+1);p&&d.push(p)}}}let u=!l.isEnding&&d.length===0&&!l.hasChoices;return{id:o,children:d,depth:i,isOrphan:!1,isDeadEnd:u}}if(e[1]){let o=r("1",0);o&&s.push(o)}for(let o of t)n.has(o)||s.push({id:o,children:[],depth:0,isOrphan:!0,isDeadEnd:!1});return s}function O(e,t){let n=[],s=Object.keys(e);for(let i of s){let l=e[i];!l.content.trim()&&!l.isEnding&&n.push({type:"warning",message:"Page has no content",pageId:i})}let r=Be(e),o=ze(r);for(let i of o)i.isOrphan&&n.push({type:"warning",message:"Page is not reachable from the start",pageId:i.id});for(let i of o)i.isDeadEnd&&n.push({type:"warning",message:"Page has no choices and is not marked as ending",pageId:i.id});for(let i of s){let l=e[i],d=We(l.content);for(let u of d)t[u]||t[`${u}.png`]||t[`${u}.jpg`]||t[`${u}.jpeg`]||t[`${u}.gif`]||t[`${u}.webp`]||t[`${u}.mp4`]||t[`${u}.webm`]||t[`${u}.mp3`]||t[`${u}.wav`]||n.push({type:"warning",message:`Missing asset: ${u}`,pageId:i})}for(let i of s){let l=e[i];if(l.hasChoices&&!l.isEnding){let d=E(i,l.choices.length||2);for(let[u,g]of Object.entries(d)){let f=l.choices.find(x=>x.letter===u);if(!f)continue;let p=f.goto||g;e[p]||n.push({type:"info",message:`Choice "${u}" leads to missing page: ${p}`,pageId:i})}}}return e[1]||n.push({type:"error",message:"Story is missing page 1 (starting page)"}),n}function ze(e){let t=[];function n(s){t.push(s);for(let r of s.children)n(r)}for(let s of e)n(s);return t}function We(e){let t=[],n=/\{([^}:]+?)(?::(\w+))?\}/g,s;for(;(s=n.exec(e))!==null;){let r=s[1];r.includes(":")||r==="/if"||["set","add","sub","if","music","sfx","ambient","goto","stop"].some(o=>r.startsWith(o+":"))||t.push(r)}return t}function K(e){return{characters:A(e.content),words:T(e.content),paragraphs:D(e.content),pages:1}}function Y(e){let t={characters:0,words:0,paragraphs:0,pages:Object.keys(e).length};for(let n of Object.values(e))t.characters+=A(n.content),t.words+=T(n.content),t.paragraphs+=D(n.content);return t}function Ve(e){return new Promise((t,n)=>{let s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>n(s.error),s.readAsDataURL(e)})}async function Q(e){let t={};for(let n of Array.from(e))try{let s=await Ve(n),r=v(n.name);t[r]={data:s,type:n.type}}catch(s){console.error(`Failed to read file ${n.name}:`,s)}return t}function X(e){let t=e.toLowerCase().split(".").pop()||"";return["png","jpg","jpeg","gif","webp","svg","bmp"].includes(t)?"image":["mp4","webm","mov","avi","mkv"].includes(t)?"video":["mp3","wav","ogg","flac","aac","m4a"].includes(t)?"audio":"unknown"}function j(e){switch(X(e)){case"image":return"\u{1F5BC}\uFE0F";case"video":return"\u{1F3AC}";case"audio":return"\u{1F3B5}";default:return"\u{1F4C4}"}}function ee(e,t){let n=X(t),s=document.createElement("div");if(s.className="asset-preview-content",n==="image"){let r=document.createElement("img");r.src=e.data,r.alt=t,s.appendChild(r)}else if(n==="video"){let r=document.createElement("video");r.src=e.data,r.controls=!0,r.muted=!0,r.preload="metadata",s.appendChild(r)}else if(n==="audio"){let r=document.createElement("audio");r.src=e.data,r.controls=!0,r.preload="metadata",s.appendChild(r)}else{let r=document.createElement("span");r.textContent=j(t),r.className="asset-icon",s.appendChild(r)}return s}function te(e){return new Promise((t,n)=>{let s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>n(s.error),s.readAsDataURL(e)})}var ne="cyoa_editor_drafts",$="cyoa_editor_autosave";function R(){try{let e=localStorage.getItem(ne);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to load drafts:",e),{}}}function se(e){try{return localStorage.setItem(ne,JSON.stringify(e)),!0}catch(t){if(t instanceof DOMException&&t.name==="QuotaExceededError")return console.error("localStorage quota exceeded"),!1;throw t}}function ae(e,t,n,s){let r=R();return r[e]={pages:t,assets:n,metadata:s,savedAt:new Date().toISOString()},se(r)}function re(e){let n=R()[e];if(!n)return null;let s={};for(let[r,o]of Object.entries(n.pages))H(o)?s[r]=N(o):s[r]=o;return{...n,pages:s}}function oe(e){let t=R();return t[e]?(delete t[e],se(t)):!1}function ie(){let e=R();return Object.entries(e).sort((t,n)=>{let s=new Date(t[1].savedAt).getTime();return new Date(n[1].savedAt).getTime()-s}).map(([t])=>t)}function ce(e,t,n,s){try{let r={pages:e,assets:t,metadata:n,storyName:s,savedAt:new Date().toISOString()};return localStorage.setItem($,JSON.stringify(r)),!0}catch(r){return console.error("Auto-save failed:",r),!1}}function le(){try{let e=localStorage.getItem($);if(!e)return null;let t=JSON.parse(e),n={};for(let[s,r]of Object.entries(t.pages||{}))H(r)?n[s]=N(r):n[s]=r;return{...t,pages:n}}catch(e){return console.error("Failed to load auto-save:",e),null}}function F(){localStorage.removeItem($)}function de(){return localStorage.getItem($)!==null}var _e=50;function U(){return{undoStack:[],redoStack:[]}}function ue(e,t,n,s){let r={type:"edit",pageId:t,before:n?m(n):null,after:s?m(s):null};z(e,r)}function ge(e,t,n,s){let r={type:"delete",pageId:t,before:m(n),after:null,affectedPages:s?m(s):void 0};z(e,r)}function B(e,t,n){let s={type:"create",pageId:t,before:null,after:m(n)};z(e,s)}function z(e,t){e.undoStack.push(t),e.redoStack=[],e.undoStack.length>_e&&e.undoStack.shift()}function pe(e){return e.undoStack.length>0}function fe(e){return e.redoStack.length>0}function me(e,t){let n=e.undoStack.pop();if(!n)return null;let s={...t};switch(n.type){case"edit":n.before?s[n.pageId]=m(n.before):delete s[n.pageId];break;case"delete":if(n.before&&(s[n.pageId]=m(n.before)),n.affectedPages)for(let[r,o]of Object.entries(n.affectedPages))s[r]=m(o);break;case"create":delete s[n.pageId];break;case"rename":if(n.before&&(s[n.pageId]=m(n.before)),n.affectedPages)for(let r of Object.keys(n.affectedPages))delete s[r];break;case"move":if(n.affectedPages)for(let[r,o]of Object.entries(n.affectedPages))s[r]=m(o);break}return e.redoStack.push(n),{pages:s,action:n}}function he(e,t){let n=e.redoStack.pop();if(!n)return null;let s={...t};switch(n.type){case"edit":n.after?s[n.pageId]=m(n.after):delete s[n.pageId];break;case"delete":if(delete s[n.pageId],n.affectedPages)for(let r of Object.keys(n.affectedPages))delete s[r];break;case"create":n.after&&(s[n.pageId]=m(n.after));break;case"rename":if(delete s[n.pageId],n.affectedPages)for(let[r,o]of Object.entries(n.affectedPages))s[r]=m(o);break;case"move":n.after&&(s[n.pageId]=m(n.after));break}return e.undoStack.push(n),{pages:s,action:n}}async function ye(e){let t={success:!1,pages:{},assets:{},errors:[]};try{let n=new JSZip;await n.loadAsync(e);let s="",o=Object.keys(n.files).find(l=>!n.files[l].dir);o&&o.includes("/")&&(s=o.split("/")[0]+"/");for(let[l,d]of Object.entries(n.files)){if(d.dir)continue;let u=l.replace(s,"");if(!u.startsWith("assets/")){if(u==="story.json"||u==="metadata.json"){try{let g=await d.async("string");t.metadata=JSON.parse(g)}catch(g){t.errors?.push(`Failed to parse metadata: ${g}`)}continue}if(u.endsWith(".txt")){let g=u.replace(".txt","");if(!h(g)){t.errors?.push(`Invalid page ID: ${g}`);continue}try{let p=await d.async("string"),x=ve(p);t.pages[g]=x}catch(p){t.errors?.push(`Failed to read page ${g}: ${p}`)}}}}let i=s+"assets/";for(let[l,d]of Object.entries(n.files)){if(d.dir||!l.startsWith(i))continue;let u=l.replace(i,"");if(u)try{let g=await d.async("blob"),f=await te(g),p=v(u);t.assets[p]={data:f,type:g.type||xe(u)}}catch(g){t.errors?.push(`Failed to read asset ${u}: ${g}`)}}t.success=Object.keys(t.pages).length>0,t.pages[1]||t.errors?.push("No starting page (1.txt) found")}catch(n){t.errors?.push(`Failed to read ZIP file: ${n}`)}return t}async function be(e){let t={success:!1,pages:{},assets:{},errors:[]};try{for(let n of Array.from(e)){let o=(n.webkitRelativePath||n.name).split("/").slice(1).join("/");if(o.startsWith("assets/")){let i=o.replace("assets/","");if(!i)continue;try{let l=await Ge(n),d=v(i);t.assets[d]={data:l,type:n.type||xe(i)}}catch(l){t.errors?.push(`Failed to read asset ${i}: ${l}`)}continue}if(o==="story.json"||o==="metadata.json"){try{let i=await n.text();t.metadata=JSON.parse(i)}catch(i){t.errors?.push(`Failed to parse metadata: ${i}`)}continue}if(o.endsWith(".txt")){let i=o.replace(".txt","");if(!h(i)){t.errors?.push(`Invalid page ID: ${i}`);continue}try{let d=await n.text(),u=ve(d);t.pages[i]=u}catch(d){t.errors?.push(`Failed to read page ${i}: ${d}`)}}}t.success=Object.keys(t.pages).length>0,t.pages[1]||t.errors?.push("No starting page (1.txt) found")}catch(n){t.errors?.push(`Failed to read files: ${n}`)}return t}function ve(e){let t=[],n=e,s=/^([a-e])\)\s*(?:\[(\d+[a-e]*)\]\s*)?(.+)$/gim,r;for(;(r=s.exec(e))!==null;)t.push({letter:r[1].toLowerCase(),text:r[3].trim(),goto:r[2]?.toLowerCase()});n=e.replace(/^[a-e]\)\s*(?:\[\d+[a-e]*\]\s*)?.+$/gim,"").trim();let o=t.length>0,i=e.toLowerCase().includes("[end]")||e.toLowerCase().includes("the end")||!o&&!e.includes("{goto:");return{content:n,hasChoices:o,isEnding:i&&!o,choices:o?t:[{letter:"a",text:""},{letter:"b",text:""}]}}function Ge(e){return new Promise((t,n)=>{let s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>n(s.error),s.readAsDataURL(e)})}function xe(e){let t=e.toLowerCase().split(".").pop()||"";return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",flac:"audio/flac"}[t]||"application/octet-stream"}async function Pe(e,t,n,s,r){let o=[];if(r?.validateFirst){let f=O(t,n);o.push(...f)}let i=v(e||"my-story"),l=new JSZip,d=l.folder(i);if(!d)throw new Error("Failed to create ZIP folder");let u=d.folder("assets");if(!u)throw new Error("Failed to create assets folder");s&&r?.includeMetadata!==!1&&d.file("story.json",JSON.stringify(s,null,2));for(let[f,p]of Object.entries(t)){let x=qe(p),I=v(f);d.file(`${I}.txt`,x)}for(let[f,p]of Object.entries(n)){let x=v(f),I=p.data.split(",")[1];I&&u.file(x,I,{base64:!0})}return{blob:await l.generateAsync({type:"blob"}),warnings:o}}function qe(e){let t=e.content||"";if(e.hasChoices&&!e.isEnding&&e.choices.length>0){let n=e.choices.filter(s=>s.text.trim()).map(s=>s.goto?`${s.letter}) [${s.goto}] ${s.text}`:`${s.letter}) ${s.text}`).join(`
`);n&&(t=t.trimEnd()+`

`+n)}return t}function we(e,t){let n=URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function Ie(e,t){return O(e,t)}function Se(e,t){let s=e.substring(0,t).split(`
`);return{line:s.length,column:s[s.length-1].length+1}}function Ce(e,t,n){if(!t.trim())return[];let s=[],r=n?.caseSensitive?"g":"gi",o;try{n?.regex?o=new RegExp(t,r):n?.wholeWord?o=new RegExp(`\\b${W(t)}\\b`,r):o=new RegExp(W(t),r)}catch{o=new RegExp(W(t),r)}for(let[i,l]of Object.entries(e)){let d=Ee(l.content,o);for(let u of l.choices)if(u.text){let g=Ee(u.text,o);for(let f of g)d.push({...f,context:`Choice ${u.letter}: ${f.context}`})}d.length>0&&s.push({pageId:i,matches:d})}return s}function Ee(e,t){let n=[],s;for(t.lastIndex=0;(s=t.exec(e))!==null;){let{line:r,column:o}=Se(e,s.index),i=Je(e,s.index,s[0].length);n.push({line:r,column:o,text:s[0],context:i}),s[0].length===0&&t.lastIndex++}return n}function Je(e,t,n,s=40){let r=Math.max(0,t-s),o=Math.min(e.length,t+n+s),i=e.substring(r,o);return r>0&&(i="..."+i),o<e.length&&(i=i+"..."),i=i.replace(/\n/g," "),i}function W(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ze(e){let t={totalMatches:0,pagesWithMatches:e.length,matchesByPage:{}};for(let n of e)t.matchesByPage[n.pageId]=n.matches.length,t.totalMatches+=n.matches.length;return t}function Me(e,t,n){let s=document.createElement("div");s.className="search-panel",s.innerHTML=`
    <div class="search-header">
      <h3>Search & Replace</h3>
      <button class="close-btn" title="Close">\xD7</button>
    </div>
    <div class="search-body">
      <div class="search-row">
        <input type="text" id="search-input" placeholder="Search..." />
        <button id="search-btn">Find</button>
      </div>
      <div class="search-row">
        <input type="text" id="replace-input" placeholder="Replace with..." />
        <button id="replace-btn">Replace</button>
        <button id="replace-all-btn">Replace All</button>
      </div>
      <div class="search-options">
        <label>
          <input type="checkbox" id="case-sensitive" />
          Case sensitive
        </label>
        <label>
          <input type="checkbox" id="whole-word" />
          Whole word
        </label>
      </div>
      <div class="search-results" id="search-results">
        <!-- Results will be inserted here -->
      </div>
    </div>
  `;let r=s.querySelector("#search-input"),o=s.querySelector("#replace-input"),i=s.querySelector("#case-sensitive"),l=s.querySelector("#whole-word"),d=s.querySelector(".close-btn"),u=s.querySelector("#search-btn"),g=s.querySelector("#replace-btn"),f=s.querySelector("#replace-all-btn"),p=()=>({caseSensitive:i.checked,wholeWord:l.checked});return u.onclick=()=>e(r.value,p()),r.onkeydown=x=>{x.key==="Enter"&&e(r.value,p())},g.onclick=()=>{t(r.value,o.value,{...p(),all:!1})},f.onclick=()=>{t(r.value,o.value,{...p(),all:!0})},d.onclick=n,s}function ke(e,t,n){if(t.length===0){e.innerHTML='<p class="no-results">No matches found</p>';return}let s=Ze(t);e.innerHTML=`
    <p class="results-summary">
      Found ${s.totalMatches} match${s.totalMatches!==1?"es":""}
      in ${s.pagesWithMatches} page${s.pagesWithMatches!==1?"s":""}
    </p>
    <div class="results-list">
      ${t.map(r=>`
        <div class="result-group">
          <div class="result-page" data-page="${r.pageId}">
            <span class="page-id">${r.pageId}</span>
            <span class="match-count">(${r.matches.length})</span>
          </div>
          ${r.matches.map((o,i)=>`
            <div class="result-match" data-page="${r.pageId}" data-index="${i}">
              <span class="line-number">L${o.line}</span>
              <span class="match-context">${Ke(o.context)}</span>
            </div>
          `).join("")}
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".result-page, .result-match").forEach(r=>{r.addEventListener("click",()=>{let o=r.getAttribute("data-page")||"",i=parseInt(r.getAttribute("data-index")||"0");n(o,i)})})}function Ke(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ye(e){let t=[],n=[],s=["1"],r=new Set;for(;s.length>0;){let o=s.shift();if(r.has(o)||!e[o])continue;r.add(o);let i=e[o];if(i.hasChoices&&!i.isEnding)for(let l of i.choices){let d=h(o);if(!d)continue;let u=d.num+1,g=l.goto||`${u}${d.path}${l.letter}`;e[g]&&s.push(g)}else if(!i.isEnding){let l=h(o);if(l){let d=`${l.num+1}${l.path}`;e[d]&&s.push(d)}}}for(let[o,i]of Object.entries(e)){let l="normal";i.isEnding?l="ending":i.hasChoices?l="choice":r.has(o)||(l="orphan"),t.push({id:o,label:o,type:l})}for(let[o,i]of Object.entries(e)){if(i.isEnding)continue;let l=h(o);if(l)if(i.hasChoices)for(let d of i.choices){if(!d.text.trim())continue;let u=l.num+1,g=d.goto||`${u}${l.path}${d.letter}`;e[g]&&n.push({source:o,target:g,label:d.letter})}else{let d=`${l.num+1}${l.path}`;e[d]&&n.push({source:o,target:d})}}return{nodes:t,edges:n}}function Qe(e,t,n){if(typeof cytoscape>"u")return console.error("Cytoscape.js not loaded"),null;let{nodes:s,edges:r}=Ye(t),o=[...s.map(l=>({data:{id:l.id,label:l.label,type:l.type},classes:l.type})),...r.map(l=>({data:{id:`${l.source}-${l.target}`,source:l.source,target:l.target,label:l.label||""}}))],i=cytoscape({container:e,elements:o,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","background-color":"#444",color:"#fff","font-size":"12px",width:"40px",height:"40px","border-width":"2px","border-color":"#666"}},{selector:"node.choice",style:{"background-color":"#2a3a4a","border-color":"#8ac",shape:"diamond",width:"50px",height:"50px"}},{selector:"node.ending",style:{"background-color":"#4a3a2a","border-color":"#ca8",shape:"octagon"}},{selector:"node.orphan",style:{"background-color":"#3a2a2a","border-color":"#a66","border-style":"dashed"}},{selector:"node:selected",style:{"background-color":"#5a8a5a","border-color":"#8c8","border-width":"3px"}},{selector:"edge",style:{width:2,"line-color":"#555","target-arrow-color":"#555","target-arrow-shape":"triangle","curve-style":"bezier",label:"data(label)","font-size":"10px",color:"#888","text-background-color":"#1a1a1a","text-background-opacity":1,"text-background-padding":"2px"}},{selector:"edge:selected",style:{"line-color":"#8a8","target-arrow-color":"#8a8",width:3}}],layout:{name:"dagre",rankDir:"TB",nodeSep:50,rankSep:80,fit:!0,padding:30},minZoom:.2,maxZoom:3,wheelSensitivity:.3});if(i.on("tap","node",l=>{let d=l.target.id();n(d)}),i.nodes().length>0)try{i.layout({name:"dagre",rankDir:"TB",nodeSep:50,rankSep:80,fit:!0,padding:30}).run()}catch{i.layout({name:"grid",fit:!0,padding:30}).run()}return i}function $e(e,t){let n=document.createElement("div");n.className="graph-panel",n.innerHTML=`
    <div class="graph-header">
      <h3>Story Graph</h3>
      <div class="graph-controls">
        <button id="graph-fit" title="Fit to view">Fit</button>
        <button id="graph-zoom-in" title="Zoom in">+</button>
        <button id="graph-zoom-out" title="Zoom out">-</button>
        <button class="close-btn" title="Close">\xD7</button>
      </div>
    </div>
    <div class="graph-legend">
      <span class="legend-item"><span class="legend-dot normal"></span> Normal</span>
      <span class="legend-item"><span class="legend-dot choice"></span> Choice</span>
      <span class="legend-item"><span class="legend-dot ending"></span> Ending</span>
      <span class="legend-item"><span class="legend-dot orphan"></span> Orphan</span>
    </div>
    <div class="graph-container" id="graph-container"></div>
  `;let s=n.querySelector(".close-btn");return s.onclick=e,n}function Re(e,t,n){let s=e.querySelector("#graph-container");if(!s)return null;let r=Qe(s,t,n);if(!r)return null;let o=e.querySelector("#graph-fit"),i=e.querySelector("#graph-zoom-in"),l=e.querySelector("#graph-zoom-out");return o.onclick=()=>r.fit(30),i.onclick=()=>r.zoom(r.zoom()*1.2),l.onclick=()=>r.zoom(r.zoom()*.8),r}var a={pages:{},assets:{},metadata:{title:"",author:"",description:""},currentPageId:null,storyName:"my-story",hasUnsavedChanges:!1,undoManager:U(),searchResults:[],showLineNumbers:!0,spellcheck:!0,theme:"dark"},c,Le=J(()=>{a.hasUnsavedChanges&&(ce(a.pages,a.assets,a.metadata,a.storyName),M("auto-saved"))},3e4);function Te(){if(c={storyNameInput:document.getElementById("story-name"),draftSelect:document.getElementById("draft-select"),pageTree:document.getElementById("page-tree"),editorEmpty:document.getElementById("editor-empty"),editorMain:document.getElementById("editor-main"),currentPageIdDisplay:document.getElementById("current-page-id"),pageContent:document.getElementById("page-content"),hasChoicesCheckbox:document.getElementById("has-choices"),isEndingCheckbox:document.getElementById("is-ending"),choicesSection:document.getElementById("choices-section"),choiceInputs:Array.from(document.querySelectorAll(".choice-row input")),assetsList:document.getElementById("assets-list"),assetPreview:document.getElementById("asset-preview"),lineNumbers:document.getElementById("line-numbers"),statsBar:document.getElementById("stats-bar"),saveStatus:document.getElementById("save-status"),deleteModal:document.getElementById("delete-modal"),searchPanel:null,graphPanel:null},de()){let t=le();t&&confirm("Recover unsaved changes?")&&(a.pages=t.pages,a.assets=t.assets,a.metadata=t.metadata||{title:"",author:"",description:""},a.storyName=t.storyName||"recovered-story",c.storyNameInput.value=a.storyName),F()}Object.keys(a.pages).length===0&&(a.pages[1]=C(!0)),Xe(),G(),b(),y("1"),S(),_(),et(),window.addEventListener("beforeunload",t=>{a.hasUnsavedChanges&&(t.preventDefault(),t.returnValue="")});let e=localStorage.getItem("cyoa_editor_theme");e&&Ue(e)}function Xe(){c.storyNameInput.addEventListener("input",()=>{a.storyName=c.storyNameInput.value,w()}),c.draftSelect.addEventListener("change",gt),c.pageContent.addEventListener("input",()=>{P(),He(),_(),Le()}),c.hasChoicesCheckbox.addEventListener("change",()=>Ae(!0)),c.isEndingCheckbox.addEventListener("change",nt),c.choiceInputs.forEach(s=>{s.addEventListener("input",()=>{P(),Le()})}),ut();let e=document.getElementById("asset-input");e&&e.addEventListener("change",it);let t=document.getElementById("import-zip");t&&t.addEventListener("change",mt);let n=document.getElementById("import-folder");n&&n.addEventListener("change",ht)}function et(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="s"&&(e.preventDefault(),Oe()),(e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),yt()),(e.ctrlKey||e.metaKey)&&(e.key==="Z"||e.key==="y")&&(e.preventDefault(),bt()),(e.ctrlKey||e.metaKey)&&e.key==="f"&&(e.preventDefault(),vt()),(e.ctrlKey||e.metaKey)&&e.key==="g"&&(e.preventDefault(),xt()),e.key==="Escape"&&(Fe(),V())})}function b(){let e=Z(Object.keys(a.pages));c.pageTree.innerHTML=e.map(t=>{let n=a.pages[t],s=n.isEnding?"ending":n.hasChoices?"choice":"",r=n.isEnding?"END":n.hasChoices?`${n.choices.length}ch`:"AUTO";return`
      <div class="page-item ${t===a.currentPageId?"active":""}" data-page-id="${t}">
        <span class="page-id">${t}.txt</span>
        <span class="page-type ${s}">${r}</span>
      </div>
    `}).join(""),c.pageTree.querySelectorAll(".page-item").forEach(t=>{t.addEventListener("click",()=>{let n=t.getAttribute("data-page-id");n&&y(n)})})}function y(e){a.currentPageId&&a.pages[a.currentPageId]&&P(),a.currentPageId=e;let t=a.pages[e];if(!t){c.editorEmpty.style.display="flex",c.editorMain.style.display="none";return}c.editorEmpty.style.display="none",c.editorMain.style.display="flex",c.currentPageIdDisplay.textContent=e,c.pageContent.value=t.content||"",c.hasChoicesCheckbox.checked=t.hasChoices,c.isEndingCheckbox.checked=t.isEnding,tt(t.choices),Ae(!1),He(),_(),b()}function tt(e){let t=e.find(s=>s.letter==="a"),n=e.find(s=>s.letter==="b");c.choiceInputs[0]&&(c.choiceInputs[0].value=t?.text||""),c.choiceInputs[1]&&(c.choiceInputs[1].value=n?.text||"")}function P(){if(!a.currentPageId||!a.pages[a.currentPageId])return;let e={...a.pages[a.currentPageId]};a.pages[a.currentPageId]={content:c.pageContent.value,hasChoices:c.hasChoicesCheckbox.checked,isEnding:c.isEndingCheckbox.checked,choices:[{letter:"a",text:c.choiceInputs[0]?.value||""},{letter:"b",text:c.choiceInputs[1]?.value||""}]},ue(a.undoManager,a.currentPageId,e,a.pages[a.currentPageId]),w()}function Ae(e){let t=c.hasChoicesCheckbox.checked,n=c.isEndingCheckbox.checked;t&&!n?(c.choicesSection.classList.add("visible"),e&&st()):c.choicesSection.classList.remove("visible"),t&&n&&(c.isEndingCheckbox.checked=!1),P(),b()}function nt(){c.isEndingCheckbox.checked&&(c.hasChoicesCheckbox.checked=!1,c.choicesSection.classList.remove("visible")),P(),b()}function st(){if(!a.currentPageId)return;let e=E(a.currentPageId,2);for(let t of Object.values(e))a.pages[t]||(a.pages[t]=C(!0),B(a.undoManager,t,a.pages[t]));b()}function at(){let e;if(a.currentPageId){let t=h(a.currentPageId);if(t){if(e=`${t.num+1}${t.path}`,a.pages[e]){let n=1;for(;a.pages[String(n)];)n++;e=String(n)}}else e="1"}else{let t=1;for(;a.pages[String(t)];)t++;e=String(t)}a.pages[e]=C(!0),B(a.undoManager,e,a.pages[e]),b(),y(e),w()}function rt(){if(!a.currentPageId||a.currentPageId==="1"){alert("Cannot delete the first page.");return}c.deleteModal.classList.add("visible")}function ot(){if(!a.currentPageId)return;let e=L(a.currentPageId,a.pages),t=a.pages[a.currentPageId],n={};for(let r of e)n[r]=a.pages[r],delete a.pages[r];delete a.pages[a.currentPageId],ge(a.undoManager,a.currentPageId,t,n),De(),a.currentPageId=null,b();let s=Object.keys(a.pages).sort()[0];s?y(s):(c.editorEmpty.style.display="flex",c.editorMain.style.display="none"),w()}function De(){c.deleteModal.classList.remove("visible")}async function it(e){let t=e.target;if(!t.files)return;let n=await Q(t.files);a.assets={...a.assets,...n},S(),w(),t.value=""}function S(){let e=Object.keys(a.assets).sort();if(e.length===0){c.assetsList.innerHTML=`
      <div class="asset-hint">
        Upload images, videos, or audio to use in your story.
        <br><br>
        Drag assets to the text area or click to insert.
      </div>
    `;return}c.assetsList.innerHTML=e.map(t=>{let n=j(t);return`
      <div class="asset-item" draggable="true" data-filename="${t}">
        <span class="asset-name" title="Click to insert">${n} {${t}}</span>
        <button class="delete-asset" data-name="${t}">\xD7</button>
      </div>
    `}).join(""),c.assetsList.querySelectorAll(".asset-item").forEach(t=>{let n=t.getAttribute("data-filename");t.querySelector(".asset-name")?.addEventListener("click",()=>ct(n)),t.querySelector(".delete-asset")?.addEventListener("click",s=>{s.stopPropagation(),lt(n)}),t.addEventListener("dragstart",s=>{s.dataTransfer?.setData("text/plain",`{${n}}`),t.classList.add("dragging")}),t.addEventListener("dragend",()=>{t.classList.remove("dragging")}),t.addEventListener("mouseenter",()=>dt(n)),t.addEventListener("mouseleave",Ne)})}function ct(e){let t=c.pageContent,n=t.selectionStart,s=t.value,r=`{${e}}`;t.value=s.slice(0,n)+r+s.slice(n),t.focus(),t.setSelectionRange(n+r.length,n+r.length),P()}function lt(e){delete a.assets[e],S(),Ne(),w()}function dt(e){let t=a.assets[e];t&&(c.assetPreview.innerHTML="",c.assetPreview.appendChild(ee(t,e)),c.assetPreview.style.display="block")}function Ne(){c.assetPreview.style.display="none"}function ut(){let e=c.pageContent;e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over");let n=t.dataTransfer?.getData("text/plain");if(n){let s=e.selectionStart;e.value=e.value.slice(0,s)+n+e.value.slice(s),e.setSelectionRange(s+n.length,s+n.length),P()}})}function He(){if(!c.lineNumbers||!a.showLineNumbers)return;let e=c.pageContent.value.split(`
`).length;c.lineNumbers.textContent=Array.from({length:e},(t,n)=>n+1).join(`
`)}function _(){if(!c.statsBar)return;let e=a.currentPageId&&a.pages[a.currentPageId]?K(a.pages[a.currentPageId]):{words:0,characters:0,paragraphs:0},t=Y(a.pages);c.statsBar.innerHTML=`
    <span class="stat-item">
      <span class="stat-label">Page:</span>
      <span class="stat-value">${e.words} words</span>
    </span>
    <span class="stat-item">
      <span class="stat-label">Total:</span>
      <span class="stat-value">${t.words} words, ${t.pages} pages</span>
    </span>
  `}function w(){a.hasUnsavedChanges=!0,M("unsaved")}function M(e){c.saveStatus&&(c.saveStatus.className=`save-status ${e}`,c.saveStatus.textContent={unsaved:"Unsaved changes",saving:"Saving...",saved:"Saved","auto-saved":"Auto-saved"}[e])}function Oe(){if(P(),!a.storyName.trim()){alert("Please enter a story name.");return}M("saving"),ae(a.storyName,a.pages,a.assets,a.metadata)?(a.hasUnsavedChanges=!1,M("saved"),G(),F()):(alert("Failed to save. Storage may be full."),M("unsaved"))}function G(){let e=ie();c.draftSelect.innerHTML='<option value="">-- Drafts --</option>'+e.map(t=>`<option value="${t}" ${t===a.storyName?"selected":""}>${t}</option>`).join("")}function gt(){let e=c.draftSelect.value;if(!e)return;let t=re(e);if(!t){alert("Draft not found.");return}a.pages=t.pages,a.assets=t.assets,a.metadata=t.metadata||{title:"",author:"",description:""},a.storyName=e,a.currentPageId=null,a.hasUnsavedChanges=!1,c.storyNameInput.value=e,b(),S();let n=Object.keys(a.pages).sort()[0];n?y(n):(c.editorEmpty.style.display="flex",c.editorMain.style.display="none")}function je(){a.hasUnsavedChanges&&!confirm("Start a new draft? Unsaved changes will be lost.")||(a.pages={1:C(!0)},a.assets={},a.metadata={title:"",author:"",description:""},a.storyName="new-story",a.currentPageId=null,a.hasUnsavedChanges=!1,a.undoManager=U(),c.storyNameInput.value="new-story",c.draftSelect.value="",b(),S(),y("1"))}function pt(){if(!a.storyName.trim()){alert("No draft selected.");return}confirm(`Delete draft "${a.storyName}"? This cannot be undone.`)&&(oe(a.storyName),G(),je())}async function ft(){P();let e=Ie(a.pages,a.assets);if(!(e.length>0&&!confirm(`Export has ${e.length} warning(s):
${e.slice(0,3).map(n=>n.message).join(`
`)}

Proceed anyway?`)))try{let{blob:t}=await Pe(a.storyName,a.pages,a.assets,a.metadata);we(t,`${v(a.storyName)}.zip`)}catch(t){alert(`Export failed: ${t}`)}}async function mt(e){let t=e.target;if(!(!t.files||!t.files[0])){try{let n=await ye(t.files[0]);if(n.success){if(a.hasUnsavedChanges&&!confirm("Import will replace current story. Continue?"))return;a.pages=n.pages,a.assets=n.assets,a.metadata=n.metadata||{title:"",author:"",description:""},a.storyName=t.files[0].name.replace(".zip",""),a.hasUnsavedChanges=!0,c.storyNameInput.value=a.storyName,b(),S(),y("1")}else alert("Import failed: "+(n.errors?.join(", ")||"Unknown error"))}catch(n){alert(`Import failed: ${n}`)}t.value=""}}async function ht(e){let t=e.target;if(!(!t.files||t.files.length===0)){try{let n=await be(t.files);if(n.success){if(a.hasUnsavedChanges&&!confirm("Import will replace current story. Continue?"))return;a.pages=n.pages,a.assets=n.assets,a.metadata=n.metadata||{title:"",author:"",description:""};let s=t.files[0].webkitRelativePath||"";a.storyName=s.split("/")[0]||"imported-story",a.hasUnsavedChanges=!0,c.storyNameInput.value=a.storyName,b(),S(),y("1")}else alert("Import failed: "+(n.errors?.join(", ")||"Unknown error"))}catch(n){alert(`Import failed: ${n}`)}t.value=""}}function yt(){if(!pe(a.undoManager))return;let e=me(a.undoManager,a.pages);if(e){if(a.pages=e.pages,b(),a.currentPageId&&a.pages[a.currentPageId])y(a.currentPageId);else{let t=Object.keys(a.pages).sort()[0];t&&y(t)}w()}}function bt(){if(!fe(a.undoManager))return;let e=he(a.undoManager,a.pages);e&&(a.pages=e.pages,b(),a.currentPageId&&a.pages[a.currentPageId]&&y(a.currentPageId),w())}function vt(){c.searchPanel||(c.searchPanel=Me((e,t)=>{a.searchResults=Ce(a.pages,e,t);let n=c.searchPanel?.querySelector("#search-results");n&&ke(n,a.searchResults,s=>{y(s)})},(e,t,n)=>{console.log("Replace:",e,"with",t,n)},Fe),document.body.appendChild(c.searchPanel))}function Fe(){c.searchPanel&&(c.searchPanel.remove(),c.searchPanel=null)}function xt(){c.graphPanel||(c.graphPanel=$e(V,e=>{y(e)}),document.body.appendChild(c.graphPanel),c.graphPanel.classList.add("visible"),setTimeout(()=>{c.graphPanel&&Re(c.graphPanel,a.pages,e=>{y(e),V()})},100))}function V(){c.graphPanel&&(c.graphPanel.classList.remove("visible"),c.graphPanel.remove(),c.graphPanel=null)}function Ue(e){a.theme=e,document.documentElement.classList.toggle("light-theme",e==="light"),localStorage.setItem("cyoa_editor_theme",e)}function Pt(){Ue(a.theme==="dark"?"light":"dark")}window.addPage=at;window.deletePage=rt;window.confirmDelete=ot;window.closeModal=De;window.saveToStorage=Oe;window.newDraft=je;window.deleteDraft=pt;window.exportStory=ft;window.toggleTheme=Pt;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Te):Te();export{at as addPage,De as closeModal,ot as confirmDelete,pt as deleteDraftAction,rt as deletePage,ft as exportStory,Te as init,je as newDraft,Oe as saveToStorage,Pt as toggleTheme};
